@page
@using SAAS_Projectplanningtool.Models.Budgetplanning
@using System
@using System.Globalization
@model SAAS_Projectplanningtool.Pages.Projects.BudgetPlanningModel

@{
    ViewData["Title"] = "Budgetplanung - " + Model.Project?.ProjectName;
}

<!-- Modern CSS Styling -->
<link rel="stylesheet" href="~/css/Budgetplanning.css" />

<div class="main-container">
    <!-- Modern Page Header -->
    <div class="page-header">
        <h1>
            <a asp-page="/Projects/Details"
               asp-route-id="@Model.Project?.ProjectId"
               class="edit-btn">
                <i class="fas fa-chart-line"></i>
            </a>
            <span>
                Budgetplanung - @Model.Project?.ProjectName
            </span>

            @if (Model.ScheduleAlreadyExists)
            {
                <a asp-page="/Projects/Scheduling" asp-route-id="@Model.Project?.ProjectId" class="edit-btn">
                    <i class="fas fa-calendar-days"></i>
                </a>
            }

        </h1>
    </div>

    <!-- Modern Project Structure Table -->
    @if (Model.ScheduleAlreadyExists)
    {
        //Planung auf Basis eines bestehenden Zeitplans

        <div class="modern-table">
            <table class="table">
                <thead>
                    <tr>
                        <th><i class="fas fa-project-diagram me-2"></i>Name</th>
                        <th><i class="fas fa-calendar-alt me-2"></i>Start</th>
                        <th><i class="fas fa-calendar-check me-2"></i>Ende</th>
                        <th><i class="fas fa-clock me-2"></i>Dauer (Tage)</th>
                        <th><i class="fas fa-info-circle me-2"></i>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var topSections = Model.Project.ProjectSections
                        .Where(ps => ps.ParentSectionId == null)
                        .OrderBy(ps => ps.ProjectSectionName);

                        RenderSections(topSections, level: 0);
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        //Planung des initialen Auftragsvolumens über Stundensatzgruppen & zusätzliche Kosten
        //Button zur Übernahme des geplanten AV ins Projectbudget.InitialBudget
        <!-- Initiale Budgetplanung ohne Terminplan -->
        <div class="main-container mt-4">
            <div class="modern-table">
                <div class="card">
                    <div class="card-header" style="background: var(--primary-gradient); color: white;">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>
                            Initiale Budgetplanung
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="post" asp-page-handler="SaveInitialBudgetPlanning">
                            <input type="hidden" name="projectId" value="@Model.Project.ProjectId" />
                            @* Hidden input mit gespeicherten Zusatzkosten als JSON *@
                            @if (Model.InitialAdditionalCosts != null && Model.InitialAdditionalCosts.Any())
                            {
                                <input type="hidden"
                                       id="savedInitialCostsData"
                                       value='@System.Text.Json.JsonSerializer.Serialize(Model.InitialAdditionalCosts)' />
                            }

                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-users-cog me-2"></i>
                                    Stundensatzgruppen und geschätzte Stunden
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="initialHRGTable">
                                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                            <tr>
                                                <th style="width: 30%;">Stundensatzgruppe</th>
                                                <th style="width: 15%;">Stundensatz (€)</th>
                                                <th style="width: 15%;">Anzahl Arbeiter</th>
                                                <th style="width: 20%;">Geschätzte Stunden</th>
                                                <th style="width: 20%;">Gesamtkosten (€)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="initialHRGTableBody">
                                            @if (Model.AllHourlyRateGroups != null && Model.AllHourlyRateGroups.Any())
                                            {
                                                int index = 0;
                                                @foreach (var hrg in Model.AllHourlyRateGroups.Where(h => !h.DeleteFlag))
                                                {
                                                    // Finde gespeicherte Werte für diese HRG
                                                    var savedPlanning = Model.InitialHRGPlannings?.FirstOrDefault(p => p.HourlyRateGroupId == hrg.HourlyRateGroupId);
                                                    var savedAmount = savedPlanning?.Amount ?? 0;
                                                    var savedHours = savedPlanning?.EstimatedHours ?? 0;

                                                    <tr data-hrg-id="@hrg.HourlyRateGroupId" data-index="@index">
                                                        <td>
                                                            <strong>@hrg.HourlyRateGroupName</strong>
                                                            <input type="hidden" name="InitialHRGPlannings[@index].HourlyRateGroupId" value="@hrg.HourlyRateGroupId" />
                                                            <input type="hidden" name="InitialHRGPlannings[@index].HourlyRateGroupName" value="@hrg.HourlyRateGroupName" />
                                                            <input type="hidden" name="InitialHRGPlannings[@index].HourlyRate" value="@hrg.HourlyRate" />
                                                        </td>
                                                        <td>
                                                            <span class="text-success fw-bold hourly-rate" data-rate="@hrg.HourlyRate">@hrg.HourlyRate.ToString("F2") €</span>
                                                        </td>
                                                        <td>
                                                            <input type="number"
                                                                   class="form-control initial-amount-input"
                                                                   name="InitialHRGPlannings[@index].Amount"
                                                                   min="0"
                                                                   value="@savedAmount"
                                                                   placeholder="0"
                                                                   data-index="@index" />
                                                        </td>
                                                        <td>
                                                            <input type="number"
                                                                   class="form-control initial-hours-input"
                                                                   name="InitialHRGPlannings[@index].EstimatedHours"
                                                                   min="0"
                                                                   step="0.5"
                                                                   value="@savedHours"
                                                                   placeholder="0.0"
                                                                   data-index="@index" />
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold text-primary row-total">0.00 €</span>
                                                        </td>
                                                    </tr>
                                                    index++;
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">
                                                        <i class="fas fa-info-circle me-2"></i>
                                                        Keine Stundensatzgruppen verfügbar
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot style="background: var(--light-bg);">
                                            <tr>
                                                <th colspan="4" class="text-end">Gesamtkosten Stundensatzgruppen:</th>
                                                <th id="totalInitialHRGCost">0.00 €</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-receipt me-2"></i>
                                    Zusätzliche Projektkosten (Material, Lizenzen, etc.)
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="initialAdditionalCostsTable">
                                        <thead style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white;">
                                            <tr>
                                                <th style="width: 60%;">Bezeichnung</th>
                                                <th style="width: 30%;">Kosten (€)</th>
                                                <th style="width: 10%;">Aktion</th>
                                            </tr>
                                        </thead>
                                        <tbody id="initialAdditionalCostsTableBody">
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    Noch keine zusätzlichen Kosten erfasst
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot style="background: var(--light-bg);">
                                            <tr>
                                                <th class="text-end">Gesamtsumme:</th>
                                                <th colspan="2" id="totalInitialAdditionalCost">0.00 €</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Neue Kosten hinzufügen -->
                                <div class="card mt-3" style="border: 2px dashed var(--border-color);">
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="newInitialCostName" class="form-label">
                                                    <i class="fas fa-tag me-1"></i>Bezeichnung
                                                </label>
                                                <input type="text"
                                                       class="form-control"
                                                       id="newInitialCostName"
                                                       placeholder="z.B. Materialkosten, Softwarelizenzen">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="newInitialCostAmount" class="form-label">
                                                    <i class="fas fa-euro-sign me-1"></i>Kosten (€)
                                                </label>
                                                <input type="number"
                                                       class="form-control"
                                                       id="newInitialCostAmount"
                                                       step="0.01"
                                                       min="0"
                                                       placeholder="0.00">
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button type="button"
                                                        class="modern-btn success w-100"
                                                        id="addInitialCostBtn">
                                                    <i class="fas fa-plus"></i> Hinzufügen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="hiddenInitialCostsContainer"></div>
                            </div>

                            <div class="card border-success mb-4">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h5 class="mb-0">
                                                <i class="fas fa-calculator me-2 text-success"></i>
                                                Geplantes Auftragsvolumen:
                                            </h5>
                                            <small class="text-muted">
                                                Stundensatzgruppen + Zusätzliche Kosten
                                            </small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <h3 class="mb-0 text-success" id="totalInitialBudget">0.00 €</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-end">
                                <button type="submit" class="modern-btn success">
                                    <i class="fas fa-save me-2"></i>
                                    Budget als Auftragsvolumen erfassen
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modal bleibt unverändert -->
<div class="modal fade" id="addHRGsModal" data-task-id="" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form method="post" asp-page-handler="SaveHRGs">
                <input type="hidden" name="ProjectTaskId" id="hrgProjectTaskId" />
                <input type="hidden" name="ProjectId" id="hrgProjectId" />

                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users-cog me-2"></i>
                        Budgetplanung – Stundensatzgruppen
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-list me-2"></i>
                                Verfügbare Stundensatzgruppen
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                        <tr>
                                            <th>Stundensatzgruppe</th>
                                            <th>Stundensatz (€)</th>
                                            <th>Anzahl Arbeiter</th>
                                            <th>Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="availableHRGsTable">
                                        @if (Model.AllHourlyRateGroups != null)
                                        {
                                            @foreach (var hrg in Model.AllHourlyRateGroups.Where(h => !h.DeleteFlag))
                                            {
                                                <tr data-hrg-id="@hrg.HourlyRateGroupId">
                                                    <td><strong>@hrg.HourlyRateGroupName</strong></td>
                                                    <td><span class="text-success fw-bold">@hrg.HourlyRate.ToString("F2") €</span></td>
                                                    <td>
                                                        <input type="number"
                                                               class="form-control hrg-amount"
                                                               min="0"
                                                               value="0"
                                                               style="width: 100px;"
                                                               data-hrg-id="@hrg.HourlyRateGroupId"
                                                               data-hrg-name="@hrg.HourlyRateGroupName"
                                                               data-hourly-rate="@hrg.HourlyRate"
                                                               placeholder="0" />
                                                    </td>
                                                    <td>
                                                        <button type="button"
                                                                class="modern-btn success small add-hrg-btn"
                                                                data-hrg-id="@hrg.HourlyRateGroupId"
                                                                data-hrg-name="@hrg.HourlyRateGroupName"
                                                                data-hourly-rate="@hrg.HourlyRate">
                                                            <i class="fas fa-plus"></i> Hinzufügen
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <hr style="border-color: var(--border-color); margin: 2rem 0;" />

                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-check-circle me-2"></i>
                                Eingeplante Stundensatzgruppen
                            </h6>
                            <div id="selectedHRGsContainer">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead style="background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%); color: white;">
                                            <tr>
                                                <th>Stundensatzgruppe</th>
                                                <th>Stundensatz (€)</th>
                                                <th>Anzahl Arbeiter</th>
                                                <th>Gesamtkosten/Stunde (€)</th>
                                                <th>Aktion</th>
                                            </tr>
                                        </thead>
                                        <tbody id="selectedHRGsTable">
                                            <!-- Dynamisch gefüllte Einträge -->
                                        </tbody>
                                        <tfoot style="background: var(--light-bg);">
                                            <tr>
                                                <th colspan="3" class="text-end">Gesamtsumme pro Stunde:</th>
                                                <th id="totalCostPerHour">0.00 €</th>
                                                <th></th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <div id="noHRGsMessage" class="text-center py-4" style="display: none; background: var(--light-bg); border-radius: var(--border-radius-sm);">
                                    <i class="fas fa-info-circle text-muted me-2"></i>
                                    <em class="text-muted">Noch keine Stundensatzgruppen eingeplant</em>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="hiddenInputsContainer"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Abbrechen
                    </button>
                    <button type="submit" class="modern-btn">
                        <i class="fas fa-save me-1"></i>Stundensatzgruppen speichern
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>

<!-- Zusätzliche Projektkosten Section -->
@if (Model.ScheduleAlreadyExists)
{
    <div class="main-container">
        <div class="expenses-section">
            <div class="expenses-header">
                <h2 class="expenses-title">
                    <i class="fas fa-receipt"></i>
                    Zusätzliche Projektkosten
                </h2>
                <button class="modern-btn info small" data-bs-toggle="modal" data-bs-target="#addProjectCostsModal">
                    <i class="fas fa-plus-circle"></i>
                    Kosten verwalten
                </button>
            </div>

            <div id="projectCostsDisplay">
                <div class="no-expenses">
                    <i class="fas fa-info-circle me-2"></i>
                    <em>Keine zusätzlichen Projektkosten erfasst</em>
                </div>
            </div>
        </div>
    </div>
}
<!-- Modal für Zusätzliche Projektkosten -->

<div class="modal fade" id="addProjectCostsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form method="post" asp-page-handler="SaveProjectCosts">
                <input type="hidden" name="projectId" value="@Model.Project.ProjectId" />

                <div class="modal-header" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                    <h5 class="modal-title">
                        <i class="fas fa-receipt me-2"></i>
                        Zusätzliche Projektkosten verwalten
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <p class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Erfassen Sie hier projektbezogene Kosten, die nicht über Stundensatzgruppen abgedeckt werden (z.B. Material, Lizenzen, externe Dienstleister, Reisekosten).
                        </p>
                    </div>

                    <!-- Bestehende Kosten -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-list me-2"></i>
                            Erfasste Kosten
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white;">
                                    <tr>
                                        <th style="width: 45%;">Bezeichnung</th>
                                        <th style="width: 25%;">Kosten (€)</th>
                                        <th style="width: 20%;">Erstellt am</th>
                                        <th style="width: 10%;">Aktion</th>
                                    </tr>
                                </thead>
                                <tbody id="projectCostsTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Keine Kosten vorhanden
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot style="background: var(--light-bg);">
                                    <tr>
                                        <th class="text-end">Gesamtsumme:</th>
                                        <th id="totalProjectCost" colspan="3">0.00 €</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <hr style="border-color: var(--border-color); margin: 1.5rem 0;" />

                    <!-- Neue Kosten hinzufügen -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-plus-circle me-2"></i>
                                Neue Kosten hinzufügen
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label for="newCostName" class="form-label">Bezeichnung</label>
                            <input type="text" class="form-control" id="newCostName" placeholder="z.B. Materialkosten">
                        </div>
                        <div class="col-md-4">
                            <label for="newCostAmount" class="form-label">Kosten (€)</label>
                            <input type="number" class="form-control" id="newCostAmount" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="modern-btn success w-100" id="addCostBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div id="hiddenCostsContainer"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Abbrechen
                    </button>
                    <button type="submit" class="modern-btn info">
                        <i class="fas fa-save me-1"></i>Kosten speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>



@if (Model.ScheduleAlreadyExists)
{
    <div class="main-container">
        <div class="budget-dashboard">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <h1><i class="fas fa-chart-pie me-3"></i>Budget Statistiken</h1>
                <div class="subtitle"> <span id="projectName">-</span></div>
            </div>
            <!-- Budget Overview Cards -->
            <div class="budget-overview">
                <div class="budget-card primary">
                    <div class="budget-card-header">
                        <div class="budget-card-title">Auftragsvolumen</div>
                        <div class="budget-card-icon" style="background: var(--primary-gradient);">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <div class="budget-card-value">
                        @if (Model.Project?.ProjectBudget?.BudgetRecalculations.Count > 0)
                        {
                            <div class="budget-card-subtitle">Nachkalkuliertes Auftragsvolumen</div>
                            @Model.Project.ProjectBudget.BudgetRecalculations.OrderByDescending(pb => pb.RecalculationDateTime).First().NewBudget.ToString("C2", new System.Globalization.CultureInfo("de-DE"))

                            <div class="budget-card-subtitle">
                                Initiales Auftragsvolumen
                                <br/>
                                @Model.Project.ProjectBudget.InitialBudget.ToString("C2", new System.Globalization.CultureInfo("de-DE"))
                            </div> 
                        }
                        else
                        {
                            @if (Model.Project?.ProjectBudget != null)
                            {
                                @Model.Project.ProjectBudget.InitialBudget.ToString("C2", new System.Globalization.CultureInfo("de-DE"))
                            }
                            else
                            {
                                @("-")
                            }
                        }
                    </div>
                    
                </div>

                <div class="budget-card success">
                    <div class="budget-card-header">
                        <div class="budget-card-title">Verbrauchtes Budget</div>
                        <div class="budget-card-icon" style="background: var(--success-color);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="budget-card-value">-</div>
                    <div class="budget-card-subtitle">Bisher ausgegeben</div>
                    <div class="budget-progress">
                        <div class="budget-progress-bar success" style="width: 0%"></div>
                        <div class="budget-progress-text">0%</div>
                    </div>
                </div>
                <div class="budget-card info">
                    <div class="budget-card-header">
                        <div class="budget-card-title">Verbleibendes Budget</div>
                        <div class="budget-card-icon" style="background: var(--info-color);">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                    </div>
                    <div class="budget-card-value">-</div>
                    <div class="budget-card-subtitle">
                        <form method="post" asp-page-handler="RecalculateProjectBudget">
                            <input type="hidden" name="projectId" value="@Model.Project?.ProjectId" />
                            <button type="submit" class="modern-btn small info" id="recalculationBtn">
                                <i class="fas fa-calculator me-1"></i>
                                Nachkalkulation anstoßen
                            </button>
                        </form>
                    </div>
                </div>
                <div class="budget-card" style="border-top: 4px solid #9b59b6;">
                    <div class="budget-card-header">
                        <div class="budget-card-title">Task-Kosten (abgeschlossen)</div>
                        <div class="budget-card-icon" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                            <i class="fas fa-tasks"></i>
                        </div>
                    </div>
                    <div class="budget-card-value" id="taskCostsValue">-</div>
                    <div class="budget-card-subtitle" id="taskCostsSubtitle">Personalkosten</div>
                    <div class="budget-progress" style="margin-top: 0.5rem;">
                        <div class="budget-progress-bar" id="taskCostsProgressBar" style="width: 0%; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);"></div>
                    </div>
                </div>
                <div class="budget-card" style="border-top: 4px solid var(--info-color);">
                    <div class="budget-card-header">
                        <div class="budget-card-title">Zusätzliche Kosten</div>
                        <div class="budget-card-icon" style="background: var(--info-color);">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                    <div class="budget-card-value" id="additionalCostsValue">-</div>
                    <div class="budget-card-subtitle" id="additionalCostsSubtitle">Material & Sonstiges</div>
                    <div class="budget-progress" style="margin-top: 0.5rem;">
                        <div class="budget-progress-bar" id="additionalCostsProgressBar" style="width: 0%; background: var(--info-color);"></div>
                    </div>
                </div>
                <div class="budget-card" style="border-top: 4px solid #9b59b6;">
                    <div class="budget-card-header">
                        <div class="budget-card-title">Task-Kosten (geplant & abgeschlossen)</div>
                        <div class="budget-card-icon" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                            <i class="fas fa-tasks"></i>
                        </div>
                    </div>
                    <div class="budget-card-value" id="taskCostsValueTotal">-</div>
                    <div class="budget-card-subtitle" id="taskCostsSubtitleTotal">Personalkosten</div>
                    <div class="budget-progress" style="margin-top: 0.5rem;">
                        <div class="budget-progress-bar" id="taskCostsProgressBarTotal" style="width: 0%; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);"></div>
                    </div>
                </div>

                <!--Recalculations-->
                <div class="budget-card" style="border-top: 4px solid var(--info-color);">
                    <div class="budget-card-header">
                        <div class="budget-card-title">Nachkalkulationen</div>
                        <div class="budget-card-icon" style="background: var(--info-color);">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                    <div class="budget-card-value" id="recalculationsValue">
                        @if (Model.Project?.ProjectBudget?.BudgetRecalculations?.Any() == true)
                        {
                            var latestRecalc = Model.Project?.ProjectBudget?.BudgetRecalculations?
                            .OrderByDescending(r => r.RecalculationDateTime)
                            .FirstOrDefault();
                            @latestRecalc?.NewBudget.ToString("C2", new System.Globalization.CultureInfo("de-DE"))
                        }
                        else
                        {
                            <span style="font-size: 1rem; color: var(--text-secondary);">Keine Nachkalkulationen</span>
                        }
                    </div>
                    @if (Model.Project?.ProjectBudget?.BudgetRecalculations?.Any() == true)
                    {
                        var count = Model.Project?.ProjectBudget?.BudgetRecalculations?.Count;
                        <div class="budget-card-subtitle">
                            @count @(count == 1 ? "Nachkalkulation" : "Nachkalkulationen") erfasst
                        </div>

                        <!-- Compact Timeline innerhalb der Card -->
                        <div class="compact-timeline">
                            <div class="compact-timeline-header">
                                <i class="fas fa-history"></i> Verlauf
                            </div>
                            @foreach (var recalc in Model.Project?.ProjectBudget?.BudgetRecalculations?.OrderByDescending(r => r.RecalculationDateTime))
                            {
                                var isLatest = recalc == Model.Project?.ProjectBudget?.BudgetRecalculations?.OrderByDescending(r => r.RecalculationDateTime).First();

                                <div class="compact-timeline-item @(isLatest ? "latest" : "")">
                                    <div class="compact-timeline-dot"></div>
                                    <div class="compact-timeline-content">
                                        <div class="compact-timeline-row">
                                            <div class="compact-date">
                                                @recalc.RecalculationDateTime.ToString("dd.MM.yy HH:mm")
                                            </div>
                                            <div class="compact-budget">
                                                @recalc.NewBudget.ToString("C2", new System.Globalization.CultureInfo("de-DE"))
                                            </div>
                                        </div>
                                        <div class="compact-user">
                                            <i class="fas fa-user"></i> @(recalc.RecalculatedBy?.EmployeeDisplayName ?? "Unbekannt")
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>



                <div class="budget-card warning">
                    <div class="budget-card-header">
                        <div class="budget-card-title">Budget Status</div>
                        <div class="budget-card-icon" style="background: var(--warning-color);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="budget-card-value">
                        <span class="status-badge on-track" id="project_budget_state">
                            <i class="fas fa-check-circle"></i>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Top Cost Sections -->
            <div class="top-sections">
                <h3 class="chart-title">
                    <i class="fas fa-trophy"></i>
                    Kostenintensivste Bereiche
                </h3>
                <div id="topSectionsList">
                    <div class="section-item">Daten werden geladen...</div>
                </div>
            </div>

            <!-- Task Statistics -->
            <div class="task-statistics">
                <div class="task-stat">
                    <div class="task-stat-value">-</div>
                    <div class="task-stat-label">Gesamt Tasks</div>
                </div>
                <div class="task-stat">
                    <div class="task-stat-value">-</div>
                    <div class="task-stat-label">Mit Budget</div>
                </div>
                <div class="task-stat">
                    <div class="task-stat-value">-</div>
                    <div class="task-stat-label">Ohne Budget</div>
                </div>
                <div class="task-stat">
                    <div class="task-stat-value">-</div>
                    <div class="task-stat-label">Ø Kosten/Task</div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    //Es wird das Auftragsvolumen geplant
}

@functions {
    private void RenderSections(IEnumerable<SAAS_Projectplanningtool.Models.Budgetplanning.ProjectSection> sections, int level)
    {
        if (sections == null || !sections.Any())
            return;

        foreach (var ps in sections)
        {
            bool hasChildren =
                (ps.SubSections != null && ps.SubSections.Any()) ||
                (ps.ProjectTasks != null && ps.ProjectTasks.Any());

            <tr class="section-row">
                <td>
                    @if (hasChildren)
                    {
                        <span class="toggle-icon" onclick="toggleRow('row-@ps.ProjectSectionId', this)" style="margin-left:@(level * 20)px;">
                            <i class="fas fa-plus"></i>
                        </span>
                    }
                    else
                    {
                        <span style="display:inline-block; margin-left:@((level * 20) + 32)px;"></span>
                    }
                    <strong>@ps.ProjectSectionName</strong>
                </td>
                @{
                    var allTasks = GetAllTasks(ps);
                    DateOnly? sectionStart = allTasks.Any() ? allTasks.Min(t => t.StartDate) : null;
                    DateOnly? sectionEnd = allTasks.Any() ? allTasks.Max(t => t.EndDate) : null;
                    int? sectionDuration = (sectionStart.HasValue && sectionEnd.HasValue) ? (sectionEnd.Value.DayNumber - sectionStart.Value.DayNumber + 1) : null;
                }
                <td>
                    <i class="fas fa-calendar-alt me-1 text-muted"></i>
                    @(sectionStart.HasValue ? sectionStart.Value.ToString("dd.MM.yyyy") : "Nicht verfügbar")
                </td>
                <td>
                    <i class="fas fa-calendar-check me-1 text-muted"></i>
                    @(sectionEnd.HasValue ? sectionEnd.Value.ToString("dd.MM.yyyy") : "Nicht verfügbar")
                </td>
                <td>
                    <i class="fas fa-clock me-1 text-muted"></i>
                    @(sectionDuration.HasValue ? sectionDuration.Value.ToString() : "Nicht verfügbar")
                </td>
                <td>
                    <div class="status-badge" style="background-color:@ps.State?.Color;">
                        @(ps.State?.StateName ?? "Kein Status")
                    </div>
                </td>
            </tr>

            if (hasChildren)
            {
                <tr id="row-@ps.ProjectSectionId" style="display:none">
                    <td colspan="5">
                        <div class="nested-content">
                            @if (ps.ProjectTasks != null && ps.ProjectTasks.Any())
                            {
                                <div class="task-table">
                                    <table class="table table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-tasks me-1"></i>Aufgabe</th>
                                                <th><i class="fas fa-calendar-alt me-1"></i>Start</th>
                                                <th><i class="fas fa-calendar-check me-1"></i>Ende</th>
                                                <th><i class="fas fa-clock me-1"></i>Dauer</th>
                                                <th><i class="fas fa-clock me-1"></i>AT</th>
                                                <th><i class="fas fa-clock me-1"></i>AS</th>
                                                <th><i class="fas fa-users me-1"></i>Stundensatzgruppen</th>
                                                <th><i class="fas fa-cog me-1"></i>Aktionen</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var task in ps.ProjectTasks)
                                            {
                                                <tr>
                                                    <td><strong>@task.ProjectTaskName</strong></td>
                                                    <td>@task.StartDate?.ToString("dd.MM.yyyy")</td>
                                                    <td>@task.EndDate?.ToString("dd.MM.yyyy")</td>
                                                    @{
                                                        int? dauer = null;
                                                        if (task.StartDate.HasValue && task.EndDate.HasValue)
                                                        {
                                                            var start = new DateTime(task.StartDate.Value.Year, task.StartDate.Value.Month, task.StartDate.Value.Day);
                                                            var end = new DateTime(task.EndDate.Value.Year, task.EndDate.Value.Month, task.EndDate.Value.Day);
                                                            dauer = (end - start).Days + 1;
                                                        }
                                                    }
                                                    <td>@(dauer.HasValue ? dauer.ToString() : "N/A") d</td>
                                                    <td>@task.DurationInDays AT</td>
                                                    <td>@task.DurationInHours Std.</td>


                                                    <td>
                                                        @if (task.ProjectTaskHourlyRateGroups?.Any() == true)
                                                        {
                                                            <!-- Moderne Anzeige der Stundensatzgruppen -->
                                                            <div class="hrg-display-container">
                                                                <!-- Status Badge -->
                                                                <div class="d-flex align-items-center mb-2">
                                                                    <span class="status-badge" style="background: var(--success-color); margin-right: 10px;">
                                                                        <i class="fas fa-check me-1"></i>Konfiguriert (@task.ProjectTaskHourlyRateGroups.Count HRG)
                                                                    </span>
                                                                </div>

                                                                <!-- HRG Cards -->
                                                                <div class="hrg-cards-grid">
                                                                    @{
                                                                        decimal totalCostPerHour = 0;
                                                                        int totalWorkers = 0;
                                                                    }
                                                                    @foreach (var hrg in task.ProjectTaskHourlyRateGroups)
                                                                    {

                                                                        decimal groupCost = (decimal)(hrg.Amount * hrg.HourlyRateGroup.HourlyRate);
                                                                        totalCostPerHour += groupCost;
                                                                        totalWorkers += hrg.Amount;

                                                                        <div class="hrg-card">
                                                                            <div class="hrg-card-header">
                                                                                <div class="hrg-name">@hrg.HourlyRateGroup.HourlyRateGroupName</div>
                                                                                <div class="hrg-count-badge">@hrg.Amount</div>
                                                                            </div>
                                                                            <div class="hrg-card-body">
                                                                                <div class="hrg-rate">@hrg.HourlyRateGroup.HourlyRate.ToString("F2")€/h</div>
                                                                                <div class="hrg-total">
                                                                                    <i class="fas fa-calculator me-1"></i>
                                                                                    @groupCost.ToString("F2")€/h
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>

                                                                <!-- Gesamtkosten Summary -->
                                                                <div class="hrg-summary-card">
                                                                    <div class="summary-row">
                                                                        <span class="summary-label">
                                                                            <i class="fas fa-users me-1"></i>Gesamt Arbeiter:
                                                                        </span>
                                                                        <span class="summary-value">@totalWorkers</span>
                                                                    </div>
                                                                    <div class="summary-row total-row">
                                                                        <span class="summary-label">
                                                                            <i class="fas fa-euro-sign me-1"></i>Kosten/Stunde:
                                                                        </span>
                                                                        <span class="summary-value total-value">@totalCostPerHour.ToString("F2")€</span>
                                                                    </div>

                                                                    @if (task.StartDate.HasValue && task.EndDate.HasValue)
                                                                    {
                                                                        // Kosten entsprechend der Task Dauer (Task Dauer / Default Workdays von Projekt)
                                                                        // wird nach jeder HRG Änderung in der Tabelle aktualisiert
                                                                        <div class="summary-row estimate-row">
                                                                            <span class="summary-label">
                                                                                <i class="fas fa-chart-line me-1"></i>Geschätzte Gesamtkosten:
                                                                            </span>
                                                                            <span class="summary-value estimate-value">
                                                                                @task.TotalCosts?.ToString("F2")€
                                                                                <small class="text-muted">(@task.DurationInDays Tage × Standard AZ)</small>
                                                                            </span>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="no-hrg-container">
                                                                <span class="status-badge" style="background: var(--warning-color);">
                                                                    <i class="fas fa-exclamation-triangle me-1"></i>Nicht gepflegt
                                                                </span>
                                                            </div>
                                                        }
                                                    </td>
                                                    <td>
                                                        @{
                                                            bool hasHRG = task?.ProjectTaskHourlyRateGroups?.Any() == true;
                                                        }
                                                        <button class="modern-btn @(hasHRG ? "warning" : "success") small open-resource-modal"
                                                                data-bs-target="#addHRGsModal"
                                                                data-task-id="@task.ProjectTaskId"
                                                                data-bs-toggle="modal">
                                                            <i class="fas @(hasHRG ? "fa-edit" : "fa-plus-circle")"></i>
                                                            @(hasHRG ? "Ändern" : "Hinzufügen")
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <em>Keine Aufgaben vorhanden</em>
                                </div>
                            }

                            @if (ps.SubSections != null && ps.SubSections.Any())
                            {
                                <div class="mt-3">
                                    <div class="modern-table">
                                        <table class="table">
                                            <tbody>
                                                @{
                                                    RenderSections(ps.SubSections, level + 1);
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            }
                        </div>
                    </td>
                </tr>
            }
        }
    }

    private List<SAAS_Projectplanningtool.Models.Budgetplanning.ProjectTask> GetAllTasks(SAAS_Projectplanningtool.Models.Budgetplanning.ProjectSection section)
    {
        var tasks = new List<SAAS_Projectplanningtool.Models.Budgetplanning.ProjectTask>();
        if (section.ProjectTasks != null)
            tasks.AddRange(section.ProjectTasks);

        if (section.SubSections != null)
        {
            foreach (var sub in section.SubSections)
                tasks.AddRange(GetAllTasks(sub));
        }
        return tasks;
    }
}
<!-- Budgetplanning script -->
<script>



            let selectedHRGs = new Map();
            document.addEventListener('DOMContentLoaded', function() {


                // Enhanced toggle function
                window.toggleRow = function(rowId, iconElem) {
                    const row = document.getElementById(rowId);
                    if (!row) return;

                    const icon = iconElem.querySelector('i');

                    if (row.style.display === "none" || row.style.display === "") {
                        row.style.display = "table-row";
                        icon.className = "fas fa-minus";
                        iconElem.style.background = "var(--accent-color)";
                    } else {
                        row.style.display = "none";
                        icon.className = "fas fa-plus";
                        iconElem.style.background = "var(--primary-color)";
                    }
                };
                //Add button functionality
               document.addEventListener('click', function(e) {
                if (e.target.closest('.add-hrg-btn')) {
                    const btn = e.target.closest('.add-hrg-btn');
                    const hrgId = btn.dataset.hrgId;
                    const hrgName = btn.dataset.hrgName;
                    const hourlyRate = parseFloat(btn.dataset.hourlyRate);

                    const row = btn.closest('tr'); // nur Input in dieser Zeile greifen
                    const amountInput = row.querySelector(`input[data-hrg-id="${hrgId}"]`);
                    const amount = parseInt(amountInput.value) || 0;

                    if (amount <= 0) {
                        showNotification('Bitte geben Sie eine gültige Anzahl von Arbeitern ein.', 'warning');
                        amountInput.focus();
                        return;
                    }

                    // Wenn die HRG bereits existiert, addiere die Anzahl
                    if (selectedHRGs.has(hrgId)) {
                        const existing = selectedHRGs.get(hrgId);
                        existing.amount += amount;
                        selectedHRGs.set(hrgId, existing);
                    } else {
                        selectedHRGs.set(hrgId, {
                            id: hrgId,
                            name: hrgName,
                            hourlyRate: hourlyRate,
                            amount: amount
                        });
                    }

                    amountInput.value = 0;
                    updateSelectedHRGsTable();
                    showNotification(`${hrgName} wurde erfolgreich hinzugefügt!`, 'success');
                }
            });


                // Remove button functionality
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.remove-hrg-btn')) {
                        const btn = e.target.closest('.remove-hrg-btn');
                        const hrgId = btn.dataset.hrgId;
                        const hrgName = selectedHRGs.get(hrgId)?.name;

                        selectedHRGs.delete(hrgId);
                        updateSelectedHRGsTable();
                        showNotification(`${hrgName} wurde entfernt.`, 'info');
                    }
                });

                // Amount change functionality
                document.addEventListener('input', function(e) {
                    if (e.target.classList.contains('selected-hrg-amount')) {
                        const hrgId = e.target.dataset.hrgId;
                        const newAmount = parseInt(e.target.value) || 0;

                        if (selectedHRGs.has(hrgId)) {
                            const hrg = selectedHRGs.get(hrgId);
                            hrg.amount = newAmount;
                            selectedHRGs.set(hrgId, hrg);
                            updateSelectedHRGsTable();
                        }
                    }
                });

                // Update Selected HRGs Table
                function updateSelectedHRGsTable() {
                    const tableBody = document.getElementById('selectedHRGsTable');
                    const noHRGsMessage = document.getElementById('noHRGsMessage');
                    const hiddenInputsContainer = document.getElementById('hiddenInputsContainer');

                    tableBody.innerHTML = '';
                    hiddenInputsContainer.innerHTML = '';

                    let totalCostPerHour = 0;
                    let index = 0;

                    if (selectedHRGs.size === 0) {
                        noHRGsMessage.style.display = 'block';
                    } else {
                        noHRGsMessage.style.display = 'none';

                        selectedHRGs.forEach((hrg) => {
                            const totalCost = hrg.hourlyRate * hrg.amount;
                            totalCostPerHour += totalCost;

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><strong>${hrg.name}</strong></td>
                                <td><span class="text-success fw-bold">${hrg.hourlyRate.toFixed(2)} €</span></td>
                                <td>
                                    <input type="number"
                                           class="form-control selected-hrg-amount"
                                           min="1"
                                           value="${hrg.amount}"
                                           style="width: 100px;"
                                           data-hrg-id="${hrg.id}" />
                                </td>
                                <td><span class="fw-bold text-primary">${totalCost.toFixed(2)} €</span></td>
                                <td>
                                    <button type="button"
                                            class="btn btn-outline-danger btn-sm remove-hrg-btn"
                                            data-hrg-id="${hrg.id}"
                                            title="Entfernen">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);

                            // Hidden Inputs für das neue Datenmodell
                            const hrgIdInput = document.createElement('input');
                            hrgIdInput.type = 'hidden';
                            hrgIdInput.name = `HRGAmounts[${index}].HourlyRateGroupId`;
                            hrgIdInput.value = hrg.id;
                            hiddenInputsContainer.appendChild(hrgIdInput);

                            const hrgNameInput = document.createElement('input');
                            hrgNameInput.type = 'hidden';
                            hrgNameInput.name = `HRGAmounts[${index}].HourlyRateGroupName`;
                            hrgNameInput.value = hrg.name;
                            hiddenInputsContainer.appendChild(hrgNameInput);

                            const hourlyRateInput = document.createElement('input');
                            hourlyRateInput.type = 'hidden';
                            hourlyRateInput.name = `HRGAmounts[${index}].HourlyRate`;
                            hourlyRateInput.value = hrg.hourlyRate;
                            hiddenInputsContainer.appendChild(hourlyRateInput);

                            const amountInput = document.createElement('input');
                            amountInput.type = 'hidden';
                            amountInput.name = `HRGAmounts[${index}].Amount`;
                            amountInput.value = hrg.amount;
                            hiddenInputsContainer.appendChild(amountInput);

                            index++;
                        });
                    }

                    document.getElementById('totalCostPerHour').textContent = totalCostPerHour.toFixed(2) + ' €';
                }

                // Modal event handlers
                document.querySelectorAll(".open-resource-modal").forEach(btn => {
                    btn.addEventListener("click", function (e) {
                        const taskId = this.getAttribute("data-task-id");
                        const projectId = '@Model.Project?.ProjectId';

                        document.getElementById("hrgProjectTaskId").value = taskId;
                        document.getElementById("hrgProjectId").value = projectId;
                    });
                });

                // Modal reset when opened
                document.getElementById('addHRGsModal').addEventListener('shown.bs.modal', function() {

                    initializeSelectedHRGsTable(document.getElementById("hrgProjectTaskId").value);
                    document.querySelectorAll('.hrg-amount').forEach(input => {
                        input.value = 0;
                    });
                });

                async function initializeSelectedHRGsTable(taskId) {
                    selectedHRGs.clear();

                    try {
                        const response = await fetch(`/Projects/BudgetPlanning?handler=ReadTaskHRGs&taskId=${taskId}`);
                        if (!response.ok) throw new Error("Fehler beim Laden der HRGs");

                        const data = await response.json();
                        // Erwartetes JSON: [{ hourlyRateGroupId, hourlyRateGroupName, hourlyRate, amount }, ...]

                        data.forEach(hrg => {
                            selectedHRGs.set(hrg.hourlyRateGroupId, {
                                id: hrg.hourlyRateGroupId,
                                name: hrg.hourlyRateGroupName,
                                hourlyRate: parseFloat(hrg.hourlyRate),
                                amount: hrg.amount
                            });
                        });

                        updateSelectedHRGsTable();
                    } catch (err) {
                        console.error(err);
                        showNotification("Fehler beim Laden der geplanten Stundensatzgruppen", "error");
                    }
                }

                // Notification system
                function showNotification(message, type = 'info') {
                    const existingNotifications = document.querySelectorAll('.custom-notification');
                    existingNotifications.forEach(n => n.remove());

                    const notification = document.createElement('div');
                    notification.className = `custom-notification alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'error' ? 'danger' : 'info'}`;
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 9999;
                        max-width: 300px;
                        box-shadow: var(--shadow-lg);
                        border-radius: var(--border-radius);
                    `;

                    const icon = type === 'success' ? 'check-circle' :
                                type === 'warning' ? 'exclamation-triangle' :
                                type === 'error' ? 'times-circle' : 'info-circle';

                    notification.innerHTML = `
                        <i class="fas fa-${icon} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                    `;

                    document.body.appendChild(notification);

                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 4000);
                }
            });


        //Zusätzliche Aufwendungen JS
            // ====== PROJECT COSTS MANAGEMENT ======
        let projectCosts = [];

        // Load project costs on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProjectCosts();
        });

        async function loadProjectCosts() {
            const projectId = '@Model.Project.ProjectId';
            try {
                const response = await fetch(`/Projects/BudgetPlanning?handler=ReadProjectCosts&projectId=${projectId}`);
                if (!response.ok) throw new Error("Fehler beim Laden der Kosten");

                const data = await response.json();
                displayProjectCosts(data);
            } catch (err) {
                console.error(err);
            }
        }

        function displayProjectCosts(costs) {
            const container = document.getElementById('projectCostsDisplay');

            if (!costs || costs.length === 0) {
                container.innerHTML = `
                    <div class="no-expenses">
                        <i class="fas fa-info-circle me-2"></i>
                        <em>Keine zusätzlichen Projektkosten erfasst</em>
                    </div>
                `;
                return;
            }

            let totalCost = 0;
            let html = '';

            costs.forEach(cost => {
                totalCost += cost.additionalCostAmount;
                const createdDate = cost.createdTimestamp ? new Date(cost.createdTimestamp).toLocaleDateString('de-DE') : 'Unbekannt';
                const modifiedBy = cost.latestModifier || 'System';

                html += `
                    <div class="expense-item">
                        <div class="expense-item-content">
                            <span class="expense-name">
                                <i class="fas fa-tag me-2"></i>
                                ${cost.additionalCostName}
                            </span>
                            <span class="expense-meta">
                                <i class="fas fa-calendar me-1"></i>${createdDate}
                                ${cost.latestModificationTimestamp ? `<i class="fas fa-edit ms-2 me-1"></i>Zuletzt geändert: ${new Date(cost.latestModificationTimestamp).toLocaleDateString('de-DE')}` : ''}
                            </span>
                        </div>
                        <span class="expense-cost">
                            ${cost.additionalCostAmount.toFixed(2)} €
                        </span>
                    </div>
                `;
            });

            html += `
                <div class="expense-total-card">
                    <span class="expense-total-label">
                        <i class="fas fa-calculator me-2"></i>
                        Gesamte zusätzliche Kosten:
                    </span>
                    <span class="expense-total-value">
                        ${totalCost.toFixed(2)} €
                    </span>
                </div>
            `;

            container.innerHTML = html;
        }

        // Initialize costs modal
        document.getElementById('addProjectCostsModal').addEventListener('shown.bs.modal', async function() {
            projectCosts = [];
            const projectId = '@Model.Project.ProjectId';

            try {
                const response = await fetch(`/Projects/BudgetPlanning?handler=ReadProjectCosts&projectId=${projectId}`);
                if (response.ok) {
                    const data = await response.json();
                    projectCosts = data.map(c => ({
                        id: c.projectAdditionalCostsId,
                        name: c.additionalCostName,
                        amount: c.additionalCostAmount,
                        createdTimestamp: c.createdTimestamp,
                        isExisting: true
                    }));
                }
            } catch (err) {
                console.error(err);
            }

            updateProjectCostsTable();
            document.getElementById('newCostName').value = '';
            document.getElementById('newCostAmount').value = '';
        });

        // Add cost button
        document.getElementById('addCostBtn').addEventListener('click', function() {
            const nameInput = document.getElementById('newCostName');
            const amountInput = document.getElementById('newCostAmount');

            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;

            if (!name) {
                showNotification('Bitte geben Sie eine Bezeichnung ein.', 'warning');
                nameInput.focus();
                return;
            }

            if (amount <= 0) {
                showNotification('Bitte geben Sie einen gültigen Betrag ein.', 'warning');
                amountInput.focus();
                return;
            }

            projectCosts.push({
                id: null,
                name,
                amount,
                createdTimestamp: new Date().toISOString(),
                isExisting: false
            });
            updateProjectCostsTable();

            nameInput.value = '';
            amountInput.value = '';
            nameInput.focus();

            showNotification(`${name} wurde hinzugefügt!`, 'success');
        });

        // Allow Enter key in cost inputs
        document.getElementById('newCostName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('newCostAmount').focus();
            }
        });

        document.getElementById('newCostAmount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('addCostBtn').click();
            }
        });

        // Edit cost inline
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('edit-cost-name')) {
                const index = parseInt(e.target.dataset.index);
                projectCosts[index].name = e.target.value.trim();
            } else if (e.target.classList.contains('edit-cost-amount')) {
                const index = parseInt(e.target.dataset.index);
                projectCosts[index].amount = parseFloat(e.target.value) || 0;
                updateProjectCostsTable();
            }
        });

        // Remove cost
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-cost-btn')) {
                const btn = e.target.closest('.remove-cost-btn');
                const index = parseInt(btn.dataset.index);
                const costName = projectCosts[index].name;

                projectCosts.splice(index, 1);
                updateProjectCostsTable();
                showNotification(`${costName} wurde entfernt.`, 'info');
            }
        });

        // Update costs table in modal
        function updateProjectCostsTable() {
            const tableBody = document.getElementById('projectCostsTableBody');
            const hiddenContainer = document.getElementById('hiddenCostsContainer');

            tableBody.innerHTML = '';
            hiddenContainer.innerHTML = '';

            let totalCost = 0;

            if (projectCosts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Keine Kosten vorhanden
                        </td>
                    </tr>
                `;
            } else {
                projectCosts.forEach((cost, index) => {
                    totalCost += cost.amount;
                    const createdDate = cost.createdTimestamp ? new Date(cost.createdTimestamp).toLocaleDateString('de-DE') : 'Neu';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <input type="text"
                                   class="form-control edit-cost-name"
                                   value="${cost.name}"
                                   data-index="${index}"
                                   placeholder="Bezeichnung" />
                        </td>
                        <td>
                            <input type="number"
                                   class="form-control edit-cost-amount"
                                   value="${cost.amount}"
                                   step="0.01"
                                   min="0"
                                   data-index="${index}"
                                   placeholder="0.00" />
                        </td>
                        <td><small class="text-muted">${createdDate}</small></td>
                        <td>
                            <button type="button"
                                    class="btn btn-outline-danger btn-sm remove-cost-btn"
                                    data-index="${index}"
                                    title="Entfernen">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);

                    // Hidden inputs for form submission
                    if (cost.id) {
                        const idInput = document.createElement('input');
                        idInput.type = 'hidden';
                        idInput.name = `ProjectCosts[${index}].ProjectAdditionalCostsId`;
                        idInput.value = cost.id;
                        hiddenContainer.appendChild(idInput);
                    }

                    const nameInput = document.createElement('input');
                    nameInput.type = 'hidden';
                    nameInput.name = `ProjectCosts[${index}].AdditionalCostName`;
                    nameInput.value = cost.name;
                    hiddenContainer.appendChild(nameInput);

                    const amountInput = document.createElement('input');
                    amountInput.type = 'hidden';
                    amountInput.name = `ProjectCosts[${index}].AdditionalCostAmount`;
                    amountInput.value = cost.amount;
                    hiddenContainer.appendChild(amountInput);
                });
            }

            document.getElementById('totalProjectCost').textContent = totalCost.toFixed(2) + ' €';
        }

        // Reload costs after modal closes
        document.getElementById('addProjectCostsModal').addEventListener('hidden.bs.modal', function() {
            loadProjectCosts();
        });

        //Budgetstats


        // Globale Chart-Instanzen
        let budgetDistributionChart;
        let topCostSectionsChart;

        // Seite laden
        document.addEventListener('DOMContentLoaded', loadBudgetStatistics);

        async function loadBudgetStatistics() {
            try {
                const response = await fetch('/Projects/BudgetPlanning?handler=BudgetStatistics&projectId=@Model.Project.ProjectId');
                const statistics = await response.json();
                updateDashboard(statistics);
            } catch (error) {
                console.error('Fehler beim Laden der Budget-Statistiken:', error);
            }
        }
            function updateDashboard(stats) {
            if (!stats) return;

            // Projektname
            document.getElementById('projectName').textContent = stats.projectName;

            updateBudgetCards(stats);
            updateAdditionalCostsCard(stats);
            updateTaskStatistics(stats);
            updateTopSections(stats.topCostSections);
            // updateCharts(stats);

            //Recalculation
            const recalculationBtn = document.getElementById('recalculationBtn');
            if (!stats.recalculationNeeded) {
                recalculationBtn.style.display = 'none';
            }else{
                recalculationBtn.style.display = 'block';
            }
        }

        // Neue Funktion für zusätzliche Kosten Card
        function updateAdditionalCostsCard(stats) {
            const additionalCostsValue = document.getElementById('additionalCostsValue');
            const additionalCostsSubtitle = document.getElementById('additionalCostsSubtitle');

            if (additionalCostsValue) {
                additionalCostsValue.textContent = '€' + stats.additionalCosts.toLocaleString();
            }

            if (additionalCostsSubtitle && stats.additionalCostBreakdown) {
                const itemCount = stats.additionalCostBreakdown.itemCount;
                additionalCostsSubtitle.textContent = itemCount > 0
                    ? `${itemCount} Position${itemCount !== 1 ? 'en' : ''} erfasst`
                    : 'Material & Sonstiges';
            }
        }

        // Budget-Karten
        function updateBudgetCards(stats) {
            const cards = document.querySelectorAll('.budget-card-value');
            if (cards.length >= 3) {
                // cards[0].textContent = '€' + stats.initialBudget.toLocaleString();
                cards[1].textContent = '€' + stats.usedBudget.toLocaleString();
                cards[2].textContent = '€' + stats.remainingBudget.toLocaleString();
            }

            // Status Badge
            const statusBadge = document.getElementById('project_budget_state');
            const statusMap = {
                0: { text: "Unbekannt", class: "on-track", icon: "fa-check-circle" },
                1: { text: "Ausreichend", class: "on-track", icon: "fa-check-circle" },
                2: { text: "Warnung", class: "warning", icon: "fa-exclamation-triangle" },
                3: { text: "Kritisch", class: "critical", icon: "fa-times-circle" },
                4: { text: "Überschritten", class: "exceeded", icon: "fa-ban" }
            };
            const status = statusMap[stats.budgetStatus] || statusMap[0];
            statusBadge.className = `status-badge ${status.class}`;
            statusBadge.innerHTML = `<i class="fas ${status.icon}"></i> ${status.text}`;

            // Fortschrittsbalken
            const progressBar = document.querySelector('.budget-progress-bar.success');
            const progressText = document.querySelector('.budget-progress-text');
            if (progressBar && progressText) {
                progressBar.style.width = stats.utilizationPercentage + '%';
                progressText.textContent = stats.utilizationPercentage.toFixed(2) + '%';
            }

            // Task-Kosten Card
            updateTaskCostsCard(stats);

            // Zusatzkosten Card
            updateAdditionalCostsCard(stats);

        }

        function updateTaskCostsCard(stats) {
            //..Total beschreibt die Werte für alle Tasks
            // die anderen const sind die Werte für abgeschlossene Tasks
            const taskCostsValue = document.getElementById('taskCostsValue');
            const taskCostsValueTotal = document.getElementById('taskCostsValueTotal');
            const taskCostsSubtitle = document.getElementById('taskCostsSubtitle');
            const taskCostsSubtitleTotal = document.getElementById('taskCostsSubtitleTotal');
            const taskCostsProgressBar = document.getElementById('taskCostsProgressBar');
            const taskCostsProgressBarTotal = document.getElementById('taskCostsProgressBarTotal');
            //Only completed Taks values
            if (taskCostsValue) {
                taskCostsValue.textContent = '€' + stats.usedBudgetFromTasks.toLocaleString();
            }

            if (taskCostsSubtitle) {
                const tasksWithCosts = stats.tasksWithCosts || 0;
                const totalTasks = stats.totalTasks || 0;
                taskCostsSubtitle.textContent = `${tasksWithCosts} von ${totalTasks} Tasks`;
            }

            if (taskCostsProgressBar && stats.initialBudget > 0) {
                const taskPercentage = (stats.usedBudgetFromTasks / stats.initialBudget) * 100;
                taskCostsProgressBar.style.width = taskPercentage.toFixed(2) + '%';
            }

            //All Tasks Values
            if(taskCostsValueTotal){
                taskCostsValueTotal.textContent = '€' + (stats.usedBudgetFromAllTasks || 0).toLocaleString();
            }
            if(taskCostsSubtitleTotal){
                const totalTasks = stats.totalTasks || 0;
                const totalTasksTotal = stats.totalTasks || 0;
                taskCostsSubtitleTotal.textContent = `${totalTasks} von ${totalTasksTotal} Tasks`;
            }
            if (taskCostsProgressBarTotal && stats.initialBudget > 0) {
                const taskPercentageTotal = ((stats.usedBudgetFromAllTasks || 0) / stats.initialBudget) * 100;
                taskCostsProgressBarTotal.style.width = taskPercentageTotal.toFixed(2) + '%';
            }
        }
            // Funktion für zusätzliche Kosten Card
        function updateAdditionalCostsCard(stats) {
            const additionalCostsValue = document.getElementById('additionalCostsValue');
            const additionalCostsSubtitle = document.getElementById('additionalCostsSubtitle');
            const additionalCostsProgressBar = document.getElementById('additionalCostsProgressBar');

            if (additionalCostsValue) {
                additionalCostsValue.textContent = '€' + stats.additionalCosts.toLocaleString();
            }

            if (additionalCostsSubtitle && stats.additionalCostBreakdown) {
                const itemCount = stats.additionalCostBreakdown.itemCount;
                additionalCostsSubtitle.textContent = itemCount > 0
                    ? `${itemCount} Position${itemCount !== 1 ? 'en' : ''} erfasst`
                    : 'Material & Sonstiges';
            }

            if (additionalCostsProgressBar && stats.initialBudget > 0) {
                const additionalPercentage = (stats.additionalCosts / stats.initialBudget) * 100;
                additionalCostsProgressBar.style.width = additionalPercentage.toFixed(2) + '%';
            }
        }
        // Task-Statistiken
        function updateTaskStatistics(stats) {
            const taskStats = document.querySelectorAll('.task-stat-value');
            if (taskStats.length >= 4) {
                taskStats[0].textContent = stats.totalTasks;
                taskStats[1].textContent = stats.tasksWithCosts;
                taskStats[2].textContent = stats.tasksWithoutCosts;
                taskStats[3].textContent = '€' + (stats.tasksWithCosts > 0
                    ? (stats.usedBudgetFromTasks / stats.tasksWithCosts).toLocaleString()
                    : "0");
            }
        }

        // Top-Cost-Sections
        function updateTopSections(topSections) {
            const container = document.getElementById('topSectionsList');
            container.innerHTML = '';

            if (!topSections || topSections.length === 0) {
                container.innerHTML = '<div class="section-item">Keine Daten vorhanden</div>';
                return;
            }

            topSections.forEach(section => {
                const sectionHtml = `
                    <div class="section-item">
                        <div class="section-name">${section.sectionName}</div>
                        <div class="section-stats">
                            <span class="section-cost">€${section.totalCosts.toLocaleString()}</span>
                            <span class="section-percentage">${section.percentageOfTotal.toFixed(1)}%</span>
                            <span class="section-tasks">${section.taskCount} Tasks</span>
                        </div>
                    </div>
                `;
                container.innerHTML += sectionHtml;
            });
        }

    //Neues Javascript
    //Verwendung: Bei Projektanlage wird eine initiale Budgetplanung zur Ermittlung des initialen Auftragsvolumens durchgeführt (Ohne Terminplanung)
        // ====== INITIALE BUDGETPLANUNG (ohne Terminplan) ======
        document.addEventListener('DOMContentLoaded', function() {
            initializeInitialBudgetPlanning();
            loadInitialAdditionalCosts();
        });

        function initializeInitialBudgetPlanning() {
            const table = document.getElementById('initialHRGTable');
            if (!table) return;

            // Event Listener für Änderungen
            table.addEventListener('input', function(e) {
                if (e.target.classList.contains('initial-amount-input') ||
                    e.target.classList.contains('initial-hours-input')) {
                    calculateInitialBudget();
                }
            });

            calculateInitialBudget();
        }

            function calculateInitialBudget() {
        const rows = document.querySelectorAll('#initialHRGTableBody tr[data-hrg-id]');
        let totalHRGCost = 0;

        rows.forEach(row => {
            const hourlyRateText = row.querySelector('.hourly-rate').dataset.rate;
            const hourlyRate = parseFloat(hourlyRateText) || 0;
            const amount = parseInt(row.querySelector('.initial-amount-input').value) || 0;
            const hours = parseFloat(row.querySelector('.initial-hours-input').value) || 0;

            const costPerHour = hourlyRate * amount;
            const totalCost = costPerHour * hours;

            row.querySelector('.row-total').textContent = totalCost.toFixed(2) + ' €';
            totalHRGCost += totalCost;
        });

        // Update HRG Gesamtkosten
        const totalHRGElement = document.getElementById('totalInitialHRGCost');
        if (totalHRGElement) {
            totalHRGElement.textContent = totalHRGCost.toFixed(2) + ' €';
        }

        // Zusätzliche Kosten aus dem lokalen Array berechnen (nicht aus Display-Element)
        const additionalCosts = initialAdditionalCosts.reduce((sum, cost) => sum + cost.amount, 0);

        // Gesamtbudget
        const totalBudget = totalHRGCost + additionalCosts;
        const totalBudgetElement = document.getElementById('totalInitialBudget');
        if (totalBudgetElement) {
            totalBudgetElement.textContent = totalBudget.toFixed(2) + ' €';
        }
    }

        async function loadInitialAdditionalCosts() {
            const projectId = '@Model.Project?.ProjectId';
            if (!projectId) return;

            try {
                const response = await fetch(`/Projects/BudgetPlanning?handler=ReadProjectCosts&projectId=${projectId}`);
                if (!response.ok) return;

                const costs = await response.json();
                const totalCost = costs.reduce((sum, cost) => sum + (cost.additionalCostAmount || 0), 0);

                const totalElement = document.getElementById('initialAdditionalCostsTotal');
                if (totalElement) {
                    totalElement.textContent = totalCost.toFixed(2) + ' €';
                    calculateInitialBudget();
                }
            } catch (err) {
                console.error('Fehler beim Laden der zusätzlichen Kosten:', err);
            }
        }

        // Aktualisiere auch nach dem Speichern von Projektkosten
        const addProjectCostsModal = document.getElementById('addProjectCostsModal');
        if (addProjectCostsModal) {
            addProjectCostsModal.addEventListener('hidden.bs.modal', function() {
                loadInitialAdditionalCosts();
            });
        }
            // ====== INITIALE ZUSÄTZLICHE KOSTEN MANAGEMENT ======
    let initialAdditionalCosts = [];

    document.addEventListener('DOMContentLoaded', function() {
        initializeInitialAdditionalCosts();
        loadSavedInitialAdditionalCosts(); // NEU: Lade gespeicherte Kosten
    });

    // NEU: Funktion zum Laden gespeicherter Kosten aus dem Backend
    function loadSavedInitialAdditionalCosts() {
        // Prüfe ob gespeicherte Kosten existieren (aus Model)
        const savedCostsJson = document.getElementById('savedInitialCostsData')?.value;

        if (savedCostsJson) {
            try {
                const savedCosts = JSON.parse(savedCostsJson);
                initialAdditionalCosts = savedCosts.map(cost => ({
                    name: cost.AdditionalCostName,
                    amount: cost.AdditionalCostAmount
                }));
                updateInitialAdditionalCostsTable();
            } catch (e) {
                console.error('Fehler beim Laden gespeicherter Kosten:', e);
            }
        }
    }
    function initializeInitialAdditionalCosts() {
        const addBtn = document.getElementById('addInitialCostBtn');
        if (!addBtn) return;

        // Add Button
        addBtn.addEventListener('click', addInitialAdditionalCost);

        // Enter-Taste Support
        const nameInput = document.getElementById('newInitialCostName');
        const amountInput = document.getElementById('newInitialCostAmount');

        if (nameInput) {
            nameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    amountInput?.focus();
                }
            });
        }

        if (amountInput) {
            amountInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addInitialAdditionalCost();
                }
            });
        }

        // Event Delegation für Remove und Edit
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-initial-cost-btn')) {
                const btn = e.target.closest('.remove-initial-cost-btn');
                const index = parseInt(btn.dataset.index);
                removeInitialAdditionalCost(index);
            }
        });

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('edit-initial-cost-name')) {
                const index = parseInt(e.target.dataset.index);
                initialAdditionalCosts[index].name = e.target.value.trim();
            } else if (e.target.classList.contains('edit-initial-cost-amount')) {
                const index = parseInt(e.target.dataset.index);
                initialAdditionalCosts[index].amount = parseFloat(e.target.value) || 0;
                updateInitialAdditionalCostsTable();
            }
        });
    }

    function addInitialAdditionalCost() {
        const nameInput = document.getElementById('newInitialCostName');
        const amountInput = document.getElementById('newInitialCostAmount');

        if (!nameInput || !amountInput) return;

        const name = nameInput.value.trim();
        const amount = parseFloat(amountInput.value) || 0;

        if (!name) {
            showNotification('Bitte geben Sie eine Bezeichnung ein.', 'warning');
            nameInput.focus();
            return;
        }

        if (amount <= 0) {
            showNotification('Bitte geben Sie einen gültigen Betrag ein.', 'warning');
            amountInput.focus();
            return;
        }

        initialAdditionalCosts.push({ name, amount });
        updateInitialAdditionalCostsTable();

        nameInput.value = '';
        amountInput.value = '';
        nameInput.focus();

        showNotification(`${name} wurde hinzugefügt!`, 'success');
    }

    function removeInitialAdditionalCost(index) {
        const costName = initialAdditionalCosts[index].name;
        initialAdditionalCosts.splice(index, 1);
        updateInitialAdditionalCostsTable();
        showNotification(`${costName} wurde entfernt.`, 'info');
    }

    function updateInitialAdditionalCostsTable() {
        const tableBody = document.getElementById('initialAdditionalCostsTableBody');
        const hiddenContainer = document.getElementById('hiddenInitialCostsContainer');
        const totalElement = document.getElementById('totalInitialAdditionalCost');

        if (!tableBody || !hiddenContainer) return;

        tableBody.innerHTML = '';
        hiddenContainer.innerHTML = '';

        let totalCost = 0;

        if (initialAdditionalCosts.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Noch keine zusätzlichen Kosten erfasst
                    </td>
                </tr>
            `;
        } else {
            initialAdditionalCosts.forEach((cost, index) => {
                totalCost += cost.amount;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="text"
                               class="form-control edit-initial-cost-name"
                               value="${cost.name}"
                               data-index="${index}"
                               placeholder="Bezeichnung" />
                    </td>
                    <td>
                        <input type="number"
                               class="form-control edit-initial-cost-amount"
                               value="${cost.amount}"
                               step="0.01"
                               min="0"
                               data-index="${index}"
                               placeholder="0.00" />
                    </td>
                    <td>
                        <button type="button"
                                class="btn btn-outline-danger btn-sm remove-initial-cost-btn"
                                data-index="${index}"
                                title="Entfernen">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);

                // Hidden inputs für Form Submission
                const nameInput = document.createElement('input');
                nameInput.type = 'hidden';
                nameInput.name = `InitialAdditionalCosts[${index}].AdditionalCostName`;
                nameInput.value = cost.name;
                hiddenContainer.appendChild(nameInput);

                const amountInput = document.createElement('input');
                amountInput.type = 'hidden';
                amountInput.name = `InitialAdditionalCosts[${index}].AdditionalCostAmount`;
                amountInput.value = cost.amount;
                hiddenContainer.appendChild(amountInput);
            });
        }

        if (totalElement) {
            totalElement.textContent = totalCost.toFixed(2) + ' €';
        }

        // Gesamtbudget neu berechnen
        calculateInitialBudget();
    }
</script>
