@page
@using SAAS_Projectplanningtool.Pages.Projects
@model SAAS_Projectplanningtool.Pages.Projects.EditModel
@{
    ViewData["Title"] = "Projektterminplanung - " + Model.Project?.ProjectName;
}


@* @if (TempData["Message"] is SAAS_Projectplanningtool.Models.ResultMessage message)
{
    <div class="alert alert-@message.Type.ToLower() alert-dismissible fade show" role="alert">
        @message.Message
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
} *@

<style>
    /* ===== Page Container ===== */
    .scheduling-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }

    /* ===== Header Section ===== */
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 25px 30px;
        margin-bottom: 25px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

        .page-header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .page-header .project-meta {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            opacity: 0.9;
            font-size: 0.9rem;
        }

    .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

        .header-actions .btn {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
        }

    /* ===== Cards ===== */
    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 25px;
    }

    .card-header {
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

        .card-header h5 {
            margin: 0;
            font-size: 1.1rem;
            color: #333;
            font-weight: 600;
        }

    .card-body {
        padding: 0;
    }

    /* ===== Time Scale Buttons ===== */
    .time-scale-buttons .btn {
        min-width: 80px;
    }

        .time-scale-buttons .btn.active {
            background-color: #667eea;
            border-color: #667eea;
            color: white;
        }

    /* ===== Gantt Container ===== */
    .gantt-container {
        display: flex;
        overflow: hidden;
        min-height: 400px;
    }

    /* ===== Task List (Left Panel) ===== */
    .gantt-task-list {
        min-width: 500px;
        max-width: 500px;
        border-right: 2px solid #dee2e6;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    .gantt-task-header {
        display: grid;
        grid-template-columns: 200px 70px 85px 85px 60px;
        background: #e9ecef;
        font-weight: 600;
        font-size: 0.85rem;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }

        .gantt-task-header > div {
            padding: 12px 8px;
            border-right: 1px solid #dee2e6;
        }

            .gantt-task-header > div:last-child {
                border-right: none;
            }

    .gantt-task-body {
        flex: 1;
        overflow-y: auto;
    }

    /* ===== Task Row Styles ===== */
    .gantt-row {
        display: grid;
        grid-template-columns: 200px 70px 85px 85px 60px;
        border-bottom: 1px solid #eee;
        align-items: center;
        min-height: 40px;
        transition: background 0.2s;
    }

        .gantt-row:hover {
            background: #f8f9fa;
        }

        .gantt-row > div {
            padding: 8px;
            font-size: 0.85rem;
            border-right: 1px solid #eee;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

            .gantt-row > div:last-child {
                border-right: none;
            }

        /* Section Row */
        .gantt-row.section-row {
            background: #e3f2fd;
            font-weight: 600;
        }

            .gantt-row.section-row:hover {
                background: #bbdefb;
            }

        /* SubSection Row */
        .gantt-row.subsection-row {
            background: #f3e5f5;
        }

            .gantt-row.subsection-row:hover {
                background: #e1bee7;
            }

        /* Task Row */
        .gantt-row.task-row {
            background: #fff;
        }

    /* Row Name with Indentation */
    .row-name {
        display: flex;
        align-items: center;
        gap: 6px;
    }

        .row-name .caret {
            cursor: pointer;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

            .row-name .caret:hover {
                background: rgba(0,0,0,0.1);
            }

            .row-name .caret.collapsed i {
                transform: rotate(-90deg);
            }

        .row-name i {
            transition: transform 0.2s;
        }

        .row-name .icon {
            flex-shrink: 0;
        }

        .row-name .text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

    .indent-1 {
        padding-left: 20px !important;
    }

    .indent-2 {
        padding-left: 40px !important;
    }

    .indent-3 {
        padding-left: 60px !important;
    }

    .indent-4 {
        padding-left: 80px !important;
    }

    /* Row Actions */
    .row-actions {
        display: flex;
        gap: 4px;
        justify-content: center;
    }

        .row-actions .btn {
            padding: 2px 6px;
            font-size: 0.75rem;
        }

    /* ===== Timeline (Right Panel) ===== */
    .gantt-timeline {
        flex: 1;
        overflow-x: auto;
        overflow-y: hidden;
        display: flex;
        flex-direction: column;
        background: #fafafa;
    }

    .gantt-timeline-header {
        display: flex;
        background: #e9ecef;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .timeline-cell {
        min-width: var(--cell-width, 40px);
        max-width: var(--cell-width, 40px);
        text-align: center;
        font-size: 0.75rem;
        padding: 8px 2px;
        border-right: 1px solid #dee2e6;
        color: #495057;
        font-weight: 500;
    }

        .timeline-cell.weekend {
            background: #f0f0f0;
        }

        .timeline-cell.today {
            background: #e3f2fd;
            font-weight: 700;
            color: #1976d2;
        }

    .gantt-timeline-body {
        flex: 1;
        position: relative;
    }

    .timeline-row {
        display: flex;
        min-height: 40px;
        border-bottom: 1px solid #eee;
        position: relative;
    }

        .timeline-row.section-row {
            background: rgba(227, 242, 253, 0.5);
        }

        .timeline-row.subsection-row {
            background: rgba(243, 229, 245, 0.5);
        }

    .timeline-grid-cell {
        min-width: var(--cell-width, 40px);
        max-width: var(--cell-width, 40px);
        border-right: 1px solid #eee;
        height: 100%;
    }

        .timeline-grid-cell.weekend {
            background: rgba(0,0,0,0.03);
        }

    /* ===== Gantt Bars ===== */
    .gantt-bar {
        position: absolute;
        height: 24px;
        top: 50%;
        transform: translateY(-50%);
        border-radius: 4px;
        display: flex;
        align-items: center;
        padding: 0 8px;
        font-size: 0.75rem;
        color: white;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: all 0.2s;
        z-index: 5;
    }

        .gantt-bar:hover {
            transform: translateY(-50%) scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .gantt-bar.task-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gantt-bar.section-bar {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            height: 8px;
            border-radius: 4px;
        }

        .gantt-bar.subsection-bar {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            height: 8px;
            border-radius: 4px;
        }

    /* ===== Today Marker ===== */
    .today-marker {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #f44336;
        z-index: 20;
        pointer-events: none;
    }

        .today-marker::before {
            content: 'Heute';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            white-space: nowrap;
        }

    /* ===== Empty State ===== */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h4 {
            margin-bottom: 10px;
        }

    /* ===== Quick Add Section ===== */
    .quick-add-section {
        padding: 15px 20px;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }

    .quick-add-form {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

        .quick-add-form input,
        .quick-add-form select {
            border-radius: 6px;
        }

    /* ===== Collapsed Rows ===== */
    .gantt-row.collapsed-child,
    .timeline-row.collapsed-child {
        display: none !important;
    }

    /* ===== Responsive ===== */
    @@media (max-width: 992px) {
        .gantt-task-list {
            min-width: 400px;
            max-width: 400px;
        }

        .gantt-task-header,
        .gantt-row {
            grid-template-columns: 150px 60px 70px 70px 50px;
        }
    }

    @@media (max-width: 768px) {
        .page-header {
            padding: 20px;
        }

            .page-header h1 {
                font-size: 1.4rem;
            }

        .gantt-task-list {
            min-width: 280px;
            max-width: 280px;
        }

        .gantt-task-header,
        .gantt-row {
            grid-template-columns: 130px 50px 50px;
        }

            .gantt-task-header > div:nth-child(4),
            .gantt-task-header > div:nth-child(5),
            .gantt-row > div:nth-child(4),
            .gantt-row > div:nth-child(5) {
                display: none;
            }
    }
</style>

<div class="scheduling-container">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1><i class="fas fa-calendar-alt me-2"></i>Terminplan</h1>
            <div class="project-meta">
                <span><i class="fas fa-folder me-1"></i>@Model.Project?.ProjectName</span>
                @if (Model.Project?.StartDate != null && Model.Project?.EndDate != null)
                {
                    <span><i class="fas fa-clock me-1"></i>@Model.Project.StartDate?.ToString("dd.MM.yyyy") - @Model.Project.EndDate?.ToString("dd.MM.yyyy")</span>
                }
            </div>
        </div>
        <div class="header-actions">
            <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addSectionModal">
                <i class="fas fa-folder-plus me-1"></i>Abschnitt
            </button>
            <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                <i class="fas fa-plus me-1"></i>Aufgabe
            </button>
            <a href="/Projects/Details/@Model.Project?.ProjectId" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-1"></i>Zurück
            </a>
        </div>
    </div>

    <!-- Gantt Chart Card -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-chart-gantt me-2"></i>Gantt-Diagramm</h5>
            <div class="d-flex gap-3 align-items-center flex-wrap">
                <!-- Navigation Buttons -->
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="navigateTimeline(-1)" title="Zurück">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="scrollToToday()" title="Heute">
                        <i class="fas fa-crosshairs"></i> Heute
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="navigateTimeline(1)" title="Vorwärts">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <!-- Time Scale Buttons -->
                <div class="btn-group btn-group-sm time-scale-buttons">
                    <button type="button" class="btn btn-outline-secondary" data-scale="day" onclick="changeTimeScale('day')">Tag</button>
                    <button type="button" class="btn btn-outline-secondary" data-scale="week" onclick="changeTimeScale('week')">KW</button>
                    <button type="button" class="btn btn-outline-secondary" data-scale="month" onclick="changeTimeScale('month')">Monat</button>
                </div>
            </div>
        </div>
        <div class="card-body">
            @if (Model.Project?.ProjectSections == null || !Model.Project.ProjectSections.Any())
            {
                <div class="empty-state">
                    <i class="fas fa-calendar-plus"></i>
                    <h4>Noch keine Abschnitte vorhanden</h4>
                    <p>Erstellen Sie einen neuen Abschnitt, um mit der Terminplanung zu beginnen.</p>
                    <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addSectionModal">
                        <i class="fas fa-folder-plus me-1"></i>Ersten Abschnitt erstellen
                    </button>
                </div>
            }
            else
            {
                <div class="gantt-container" id="ganttContainer">
                    <!-- Task List Panel -->
                    <div class="gantt-task-list">
                        <div class="gantt-task-header">
                            <div>Aufgabe</div>
                            <div>Dauer</div>
                            <div>Start</div>
                            <div>Ende</div>
                            <div>Akt.</div>
                        </div>
                        <div class="gantt-task-body" id="taskListBody">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Timeline Panel -->
                    <div class="gantt-timeline" id="ganttTimeline">
                        <div class="gantt-timeline-header" id="timelineHeader">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="gantt-timeline-body" id="timelineBody">
                            <!-- Will be populated by JavaScript -->
                            <div class="today-marker" id="todayMarker" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Partial Modals -->
@await Html.PartialAsync("~/Pages/Projects/Modals/_AddSectionModal.cshtml", Model)
@await Html.PartialAsync("~/Pages/Projects/Modals/_AddSubSectionModal.cshtml", Model)
@await Html.PartialAsync("~/Pages/Projects/Modals/_AddItemModal.cshtml", Model)
@await Html.PartialAsync("~/Pages/Projects/Modals/_EditTaskModal.cshtml", (ProjectHandlerPageModel)Model)
@await Html.PartialAsync("~/Pages/Projects/Modals/_AddTaskModal.cshtml", (ProjectHandlerPageModel)Model, new ViewDataDictionary(ViewData) { { "Context", "Scheduling" } })
@await Html.PartialAsync("~/Pages/Projects/Modals/_DeleteConfirmationModal.cshtml", Model)

<script>
    // ===== Project Data =====
    const projectData = {
        project: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(new
        {
            Id = Model.Project?.ProjectId,
            Name = Model.Project?.ProjectName,
            StartDate = Model.Project?.StartDate?.ToString("yyyy-MM-dd"),
            EndDate = Model.Project?.EndDate?.ToString("yyyy-MM-dd")
        })),
        sections: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.Project?.ProjectSections?.Where(s => s.ParentSectionId == null)
           .OrderBy(s => s.ProjectSectionName)
           .Select(s => new
           {
               Id = s.ProjectSectionId,
               Name = s.ProjectSectionName,
               Type = "section",
               SubSections = GetSubSectionsRecursive(s),
               Tasks = s.ProjectTasks?.OrderBy(t => t.ProjectTaskName).Select(t => new
               {
                   Id = t.ProjectTaskId,
                   Name = t.ProjectTaskName,
                   StartDate = t.StartDate?.ToString("yyyy-MM-dd"),
                   EndDate = t.EndDate?.ToString("yyyy-MM-dd"),
                   Type = "task"
               })
           })
        ))
    };

    @functions {
        private object GetSubSectionsRecursive(SAAS_Projectplanningtool.Models.Budgetplanning.ProjectSection section)
        {
            return section.SubSections?.OrderBy(sub => sub.ProjectSectionName).Select(sub => new
            {
                Id = sub.ProjectSectionId,
                Name = sub.ProjectSectionName,
                Type = "subsection",
                SubSections = GetSubSectionsRecursive(sub),
                Tasks = sub.ProjectTasks?.OrderBy(t => t.ProjectTaskName).Select(t => new
                {
                    Id = t.ProjectTaskId,
                    Name = t.ProjectTaskName,
                    StartDate = t.StartDate?.ToString("yyyy-MM-dd"),
                    EndDate = t.EndDate?.ToString("yyyy-MM-dd"),
                    Type = "task"
                })
            });
        }
    }

    // ===== State =====
    const STORAGE_KEY = 'gantt_time_scale_@Model.Project?.ProjectId';
    let currentScale = localStorage.getItem(STORAGE_KEY) || 'week';
    let collapsedSections = new Set();
    let timelineStartDate = null;
    let timelineEndDate = null;
    let cellWidth = 40;

    // ===== Initialize =====
    document.addEventListener('DOMContentLoaded', function() {
        if (!projectData.sections || projectData.sections.length === 0) return;

        // Set active button
        document.querySelectorAll('.time-scale-buttons .btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.scale === currentScale);
        });

        calculateTimelineRange();
        renderGantt();

        // Scroll to today after rendering
        setTimeout(() => scrollToToday(), 100);
    });

    // ===== Calculate Timeline Range =====
    function calculateTimelineRange() {
        let minDate = null;
        let maxDate = null;
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        function processItems(items, level = 0) {
            if (!items) return;
            items.forEach(item => {
                if (item.StartDate) {
                    const start = new Date(item.StartDate);
                    if (!minDate || start < minDate) minDate = start;
                }
                if (item.EndDate) {
                    const end = new Date(item.EndDate);
                    if (!maxDate || end > maxDate) maxDate = end;
                }
                if (item.Tasks) processItems(item.Tasks, level + 1);
                if (item.SubSections) processItems(item.SubSections, level + 1);
            });
        }

        processItems(projectData.sections);

        // Use project dates as fallback
        if (!minDate && projectData.project.StartDate) {
            minDate = new Date(projectData.project.StartDate);
        }
        if (!maxDate && projectData.project.EndDate) {
            maxDate = new Date(projectData.project.EndDate);
        }

        // Default to current month if no dates
        if (!minDate) minDate = new Date(today.getFullYear(), today.getMonth(), 1);
        if (!maxDate) maxDate = new Date(today.getFullYear(), today.getMonth() + 2, 0);

        // Ensure today is always included in the range
        if (today < minDate) minDate = new Date(today);
        if (today > maxDate) maxDate = new Date(today);

        // Add padding before and after
        timelineStartDate = new Date(minDate);
        timelineStartDate.setDate(timelineStartDate.getDate() - 14);
        timelineEndDate = new Date(maxDate);
        timelineEndDate.setDate(timelineEndDate.getDate() + 30);
    }

    // ===== Change Time Scale =====
    function changeTimeScale(scale) {
        currentScale = scale;
        localStorage.setItem(STORAGE_KEY, scale);

        document.querySelectorAll('.time-scale-buttons .btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.scale === scale);
        });

        renderGantt();
    }

    // ===== Get Cell Width based on Scale =====
    function getCellWidth() {
        switch (currentScale) {
            case 'day': return 35;
            case 'week': return 60;
            case 'month': return 80;
            default: return 40;
        }
    }

    // ===== Generate Timeline Units =====
    function generateTimelineUnits() {
        const units = [];
        const current = new Date(timelineStartDate);

        switch (currentScale) {
            case 'day':
                while (current <= timelineEndDate) {
                    units.push({
                        date: new Date(current),
                        label: current.getDate().toString(),
                        subLabel: current.toLocaleDateString('de-DE', { weekday: 'short' }),
                        isWeekend: current.getDay() === 0 || current.getDay() === 6,
                        isToday: isSameDay(current, new Date())
                    });
                    current.setDate(current.getDate() + 1);
                }
                break;

            case 'week':
                // Align to Monday
                const dayOfWeek = current.getDay();
                const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                current.setDate(current.getDate() + diff);

                while (current <= timelineEndDate) {
                    const weekNum = getWeekNumber(current);
                    units.push({
                        date: new Date(current),
                        label: `KW ${weekNum}`,
                        subLabel: `${current.getDate()}.${current.getMonth() + 1}`,
                        isWeekend: false,
                        isToday: isInSameWeek(current, new Date())
                    });
                    current.setDate(current.getDate() + 7);
                }
                break;

            case 'month':
                current.setDate(1);
                while (current <= timelineEndDate) {
                    units.push({
                        date: new Date(current),
                        label: current.toLocaleDateString('de-DE', { month: 'short' }),
                        subLabel: current.getFullYear().toString(),
                        isWeekend: false,
                        isToday: isSameMonth(current, new Date())
                    });
                    current.setMonth(current.getMonth() + 1);
                }
                break;
        }

        return units;
    }

    // ===== Render Gantt Chart =====
    function renderGantt() {
        cellWidth = getCellWidth();
        document.documentElement.style.setProperty('--cell-width', cellWidth + 'px');

        const units = generateTimelineUnits();
        renderTimelineHeader(units);
        renderTaskList();
        renderTimelineBody(units);
        updateTodayMarker(units);
    }

    // ===== Render Timeline Header =====
    function renderTimelineHeader(units) {
        const header = document.getElementById('timelineHeader');
        if (!header) return;

        header.innerHTML = units.map(unit => `
            <div class="timeline-cell ${unit.isWeekend ? 'weekend' : ''} ${unit.isToday ? 'today' : ''}">
                <div>${unit.label}</div>
                <div style="font-size: 0.65rem; opacity: 0.7;">${unit.subLabel}</div>
            </div>
        `).join('');
    }

    // ===== Render Task List =====
    function renderTaskList() {
        const body = document.getElementById('taskListBody');
        if (!body) return;

        let html = '';

        function renderSection(section, level = 0) {
            const hasChildren = (section.SubSections && section.SubSections.length > 0) ||
                               (section.Tasks && section.Tasks.length > 0);
            const isCollapsed = collapsedSections.has(section.Id);
            const rowType = level === 0 ? 'section' : 'subsection';
            const dates = getSectionDates(section);

            html += `
                <div class="gantt-row ${rowType}-row" data-id="${section.Id}" data-type="${rowType}" data-level="${level}">
                    <div class="row-name indent-${level}">
                        ${hasChildren ? `
                            <span class="caret ${isCollapsed ? 'collapsed' : ''}" data-id="${section.Id}" onclick="toggleCollapse('${section.Id}')">
                                <i class="fas fa-chevron-down"></i>
                            </span>
                        ` : '<span style="width: 18px;"></span>'}
                        <i class="fas fa-folder icon" style="color: ${level === 0 ? '#2196f3' : '#9c27b0'};"></i>
                        <span class="text" title="${section.Name}">${section.Name}</span>
                    </div>
                    <div>${dates.duration || '-'}</div>
                    <div>${dates.start || '-'}</div>
                    <div>${dates.end || '-'}</div>
                    <div class="row-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="openAddSubSection('${section.Id}')" title="Unterabschnitt">
                            <i class="fas fa-folder-plus"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="openAddTask('${section.Id}')" title="Aufgabe">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `;

            // Render SubSections
            if (section.SubSections) {
                section.SubSections.forEach(sub => renderSection(sub, level + 1));
            }

            // Render Tasks
            if (section.Tasks) {
                section.Tasks.forEach(task => {
                    const duration = calculateDuration(task.StartDate, task.EndDate);
                    html += `
                        <div class="gantt-row task-row ${isCollapsed ? 'collapsed-child' : ''}"
                             data-id="${task.Id}" data-type="task" data-parent="${section.Id}" data-level="${level + 1}">
                            <div class="row-name indent-${level + 1}">
                                <span style="width: 18px;"></span>
                                <i class="fas fa-tasks icon" style="color: #667eea;"></i>
                                <span class="text" title="${task.Name}">${task.Name}</span>
                            </div>
                            <div>${duration || '-'}</div>
                            <div>${task.StartDate ? formatDate(task.StartDate) : '-'}</div>
                            <div>${task.EndDate ? formatDate(task.EndDate) : '-'}</div>
                            <div class="row-actions">
                                <button class="btn btn-outline-primary btn-sm" onclick="editTask('${task.Id}')" title="Bearbeiten">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
        }

        if (projectData.sections) {
            projectData.sections.forEach(section => renderSection(section, 0));
        }

        body.innerHTML = html;
        applyCollapsedState();
    }

    // ===== Render Timeline Body =====
    function renderTimelineBody(units) {
        const body = document.getElementById('timelineBody');
        if (!body) return;

        let html = '';
        const totalWidth = units.length * cellWidth;

        function renderTimelineRow(item, type, level, parentId = null) {
            const isCollapsed = parentId && collapsedSections.has(parentId);
            const rowClass = type === 'task' ? 'task-row' : (level === 0 ? 'section-row' : 'subsection-row');

            html += `
                <div class="timeline-row ${rowClass} ${isCollapsed ? 'collapsed-child' : ''}"
                     data-id="${item.Id}" data-parent="${parentId || ''}" style="width: ${totalWidth}px;">
                    ${units.map(unit => `
                        <div class="timeline-grid-cell ${unit.isWeekend ? 'weekend' : ''}"></div>
                    `).join('')}
                    ${renderBar(item, type, units, totalWidth)}
                </div>
            `;
        }

        function processSection(section, level = 0) {
            renderTimelineRow(section, level === 0 ? 'section' : 'subsection', level);

            if (section.SubSections) {
                section.SubSections.forEach(sub => processSection(sub, level + 1));
            }

            if (section.Tasks) {
                section.Tasks.forEach(task => {
                    renderTimelineRow(task, 'task', level + 1, section.Id);
                });
            }
        }

        if (projectData.sections) {
            projectData.sections.forEach(section => processSection(section, 0));
        }

        body.innerHTML = html;
        applyCollapsedState();
    }

    // ===== Render Bar =====
    function renderBar(item, type, units, totalWidth) {
        if (!item.StartDate || !item.EndDate) {
            // For sections, calculate from children
            if (type !== 'task') {
                const dates = getSectionDates(item);
                if (!dates.startDate || !dates.endDate) return '';
                item = { ...item, StartDate: dates.startDate, EndDate: dates.endDate };
            } else {
                return '';
            }
        }

        const startDate = new Date(item.StartDate);
        const endDate = new Date(item.EndDate);

        const position = calculateBarPosition(startDate, endDate, units);
        if (!position) return '';

        const barClass = type === 'task' ? 'task-bar' : (type === 'section' ? 'section-bar' : 'subsection-bar');
        const showText = type === 'task' && position.width > 60;

        return `
            <div class="gantt-bar ${barClass}"
                 style="left: ${position.left}px; width: ${position.width}px;"
                 title="${item.Name}: ${formatDate(item.StartDate)} - ${formatDate(item.EndDate)}">
                ${showText ? item.Name : ''}
            </div>
        `;
    }

    // ===== Calculate Bar Position =====
    function calculateBarPosition(startDate, endDate, units) {
        if (units.length === 0) return null;

        let left = 0;
        let width = 0;

        switch (currentScale) {
            case 'day':
                const startDiff = Math.floor((startDate - units[0].date) / (1000 * 60 * 60 * 24));
                const endDiff = Math.floor((endDate - units[0].date) / (1000 * 60 * 60 * 24));
                left = startDiff * cellWidth;
                width = (endDiff - startDiff + 1) * cellWidth;
                break;

            case 'week':
                const weekStart = getStartOfWeek(startDate);
                const firstWeek = getStartOfWeek(units[0].date);
                const weeksFromStart = Math.floor((weekStart - firstWeek) / (1000 * 60 * 60 * 24 * 7));
                const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24 * 7)) + 1;
                left = weeksFromStart * cellWidth;
                width = Math.max(duration * cellWidth, cellWidth);
                break;

            case 'month':
                const monthsDiff = (startDate.getFullYear() - units[0].date.getFullYear()) * 12
                                 + (startDate.getMonth() - units[0].date.getMonth());
                const monthsDuration = (endDate.getFullYear() - startDate.getFullYear()) * 12
                                      + (endDate.getMonth() - startDate.getMonth()) + 1;
                left = monthsDiff * cellWidth;
                width = Math.max(monthsDuration * cellWidth, cellWidth);
                break;
        }

        return { left, width };
    }

    // ===== Update Today Marker =====
    function updateTodayMarker(units) {
        const marker = document.getElementById('todayMarker');
        if (!marker || units.length === 0) return;

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let position = -1;

        switch (currentScale) {
            case 'day':
                for (let i = 0; i < units.length; i++) {
                    if (isSameDay(units[i].date, today)) {
                        position = i * cellWidth + cellWidth / 2;
                        break;
                    }
                }
                break;

            case 'week':
                for (let i = 0; i < units.length; i++) {
                    if (isInSameWeek(units[i].date, today)) {
                        const dayInWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                        position = i * cellWidth + (dayInWeek / 7) * cellWidth;
                        break;
                    }
                }
                break;

            case 'month':
                for (let i = 0; i < units.length; i++) {
                    if (isSameMonth(units[i].date, today)) {
                        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                        position = i * cellWidth + (today.getDate() / daysInMonth) * cellWidth;
                        break;
                    }
                }
                break;
        }

        if (position >= 0) {
            marker.style.left = position + 'px';
            marker.style.display = 'block';
        } else {
            marker.style.display = 'none';
        }
    }

    // ===== Toggle Collapse =====
    function toggleCollapse(sectionId) {
        if (collapsedSections.has(sectionId)) {
            collapsedSections.delete(sectionId);
        } else {
            collapsedSections.add(sectionId);
        }
        applyCollapsedState();

        // Update caret icon
        const caret = document.querySelector(`.caret[data-id="${sectionId}"]`);
        if (caret) {
            caret.classList.toggle('collapsed', collapsedSections.has(sectionId));
        }
    }

    // ===== Apply Collapsed State =====
    function applyCollapsedState() {
        function hideChildren(parentId) {
            // Hide direct children
            document.querySelectorAll(`[data-parent="${parentId}"]`).forEach(el => {
                el.classList.add('collapsed-child');
            });

            // Find subsections and hide their children too
            document.querySelectorAll(`.gantt-row[data-parent="${parentId}"][data-type="subsection"]`).forEach(subsection => {
                hideChildren(subsection.dataset.id);
            });
        }

        function showChildren(parentId) {
            document.querySelectorAll(`[data-parent="${parentId}"]`).forEach(el => {
                el.classList.remove('collapsed-child');

                // If this is a subsection that's not collapsed, show its children too
                if (el.dataset.type === 'subsection' && !collapsedSections.has(el.dataset.id)) {
                    showChildren(el.dataset.id);
                }
            });
        }

        // First, show all
        document.querySelectorAll('.collapsed-child').forEach(el => {
            el.classList.remove('collapsed-child');
        });

        // Then hide collapsed
        collapsedSections.forEach(sectionId => {
            hideChildren(sectionId);
        });
    }

    // ===== Navigation =====
    function navigateTimeline(direction) {
        const timeline = document.getElementById('ganttTimeline');
        if (!timeline) return;

        const scrollAmount = cellWidth * 5 * direction;
        timeline.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }

    function scrollToToday() {
        const marker = document.getElementById('todayMarker');
        const timeline = document.getElementById('ganttTimeline');
        if (!marker || !timeline) return;

        // Calculate today's position even if marker is hidden
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const units = generateTimelineUnits();

        let position = -1;

        switch (currentScale) {
            case 'day':
                for (let i = 0; i < units.length; i++) {
                    if (isSameDay(units[i].date, today)) {
                        position = i * cellWidth + cellWidth / 2;
                        break;
                    }
                }
                break;

            case 'week':
                for (let i = 0; i < units.length; i++) {
                    if (isInSameWeek(units[i].date, today)) {
                        const dayInWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                        position = i * cellWidth + (dayInWeek / 7) * cellWidth;
                        break;
                    }
                }
                break;

            case 'month':
                for (let i = 0; i < units.length; i++) {
                    if (isSameMonth(units[i].date, today)) {
                        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                        position = i * cellWidth + (today.getDate() / daysInMonth) * cellWidth;
                        break;
                    }
                }
                break;
        }

        if (position >= 0) {
            const timelineWidth = timeline.clientWidth;
            timeline.scrollTo({ left: Math.max(0, position - timelineWidth / 3), behavior: 'smooth' });
        }
    }

    // ===== Helper Functions =====
    function getSectionDates(section) {
        let minStart = null;
        let maxEnd = null;

        function processItems(items) {
            if (!items) return;
            items.forEach(item => {
                if (item.StartDate) {
                    const start = new Date(item.StartDate);
                    if (!minStart || start < minStart) minStart = start;
                }
                if (item.EndDate) {
                    const end = new Date(item.EndDate);
                    if (!maxEnd || end > maxEnd) maxEnd = end;
                }
                if (item.Tasks) processItems(item.Tasks);
                if (item.SubSections) processItems(item.SubSections);
            });
        }

        if (section.Tasks) processItems(section.Tasks);
        if (section.SubSections) processItems(section.SubSections);

        return {
            startDate: minStart ? minStart.toISOString().split('T')[0] : null,
            endDate: maxEnd ? maxEnd.toISOString().split('T')[0] : null,
            start: minStart ? formatDate(minStart.toISOString().split('T')[0]) : null,
            end: maxEnd ? formatDate(maxEnd.toISOString().split('T')[0]) : null,
            duration: minStart && maxEnd ? calculateDuration(minStart.toISOString().split('T')[0], maxEnd.toISOString().split('T')[0]) : null
        };
    }

    function calculateDuration(startDate, endDate) {
        if (!startDate || !endDate) return null;
        const start = new Date(startDate);
        const end = new Date(endDate);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        return days + ' T';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
    }

    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }

    function isSameDay(d1, d2) {
        return d1.getFullYear() === d2.getFullYear() &&
               d1.getMonth() === d2.getMonth() &&
               d1.getDate() === d2.getDate();
    }

    function isInSameWeek(d1, d2) {
        const week1 = getStartOfWeek(d1).getTime();
        const week2 = getStartOfWeek(d2).getTime();
        return week1 === week2;
    }

    function isSameMonth(d1, d2) {
        return d1.getFullYear() === d2.getFullYear() &&
               d1.getMonth() === d2.getMonth();
    }

    // ===== Modal Functions =====
    function openAddSubSection(parentSectionId) {
        // Set parent section in modal if available
        const modal = document.getElementById('addSectionModal');
        if (modal) {
            const select = modal.querySelector('#parentSectionSelect');
            if (select) {
                select.value = parentSectionId;
            }
            new bootstrap.Modal(modal).show();
        }
    }

    function openAddTask(sectionId) {
        const modal = document.getElementById('addTaskModal');
        if (modal) {
            const select = modal.querySelector('#taskSectionSelect');
            if (select) {
                select.value = sectionId;
            }
            new bootstrap.Modal(modal).show();
        }
    }

    function editTask(taskId) {
        // Find task data
        let taskData = null;
        function findTask(items) {
            if (!items) return;
            for (const item of items) {
                if (item.Tasks) {
                    const task = item.Tasks.find(t => t.Id === taskId);
                    if (task) { taskData = task; return; }
                }
                if (item.SubSections) findTask(item.SubSections);
            }
        }
        findTask(projectData.sections);

        if (taskData) {
            const modal = document.getElementById('editTaskModal');
            if (modal) {
                // Populate modal fields
                const nameInput = modal.querySelector('input[name="Name"]');
                const startInput = modal.querySelector('input[name="StartDate"]');
                const endInput = modal.querySelector('input[name="EndDate"]');
                const taskIdInput = modal.querySelector('input[name="taskId"]');

                if (nameInput) nameInput.value = taskData.Name || '';
                if (startInput) startInput.value = taskData.StartDate || '';
                if (endInput) endInput.value = taskData.EndDate || '';
                if (taskIdInput) taskIdInput.value = taskId;

                new bootstrap.Modal(modal).show();
            }
        }
    }

    // Sync scroll between task list and timeline
    document.addEventListener('DOMContentLoaded', function() {
        const taskBody = document.getElementById('taskListBody');
        const timelineBody = document.getElementById('timelineBody');

        if (taskBody && timelineBody) {
            taskBody.addEventListener('scroll', function() {
                timelineBody.style.marginTop = -taskBody.scrollTop + 'px';
            });
        }
    });
</script>



