@page
@using SAAS_Projectplanningtool.Pages.Projects
@model SAAS_Projectplanningtool.Pages.Projects.EditModel
@{
    ViewData["Title"] = "Projektterminplanung - " + Model.Project?.ProjectName;
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>@ViewData["Title"]</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-page="./Index">Projekte</a></li>
                    <li class="breadcrumb-item active">Terminplanung</li>
                </ol>
            </nav>
        </div>
    </div>
    <!-- Delete Feedbackhandling (should only be displayed for certain amount of seconds-->
@{
    var message = TempData.GetMessage();
}
@if (message != null)
{
    <div class="alert alert-@message.Type.ToLower()" id="feedback-message">
        @message.Message
    </div>

    <script>
        setTimeout(function () {
            var msg = document.getElementById('feedback-message');
            if (msg) {
                msg.style.transition = "opacity 0.5s ease";
                msg.style.opacity = 0;
                setTimeout(() => msg.remove(), 500); // Remove after fade
            }
        }, 3000); // Display for 3 seconds
    </script>
}

    <!-- Toolbar -->
    <div class="row mb-3">
        <div class="col">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="showAddSectionModal()">
                    <i class="fas fa-plus"></i> Abschnitt hinzufügen
                </button>
                <button type="button" class="btn btn-secondary" onclick="showAddTaskModal()">
                    <i class="fas fa-tasks"></i> Aufgabe hinzufügen
                </button>
                <button type="button" class="btn btn-info" onclick="toggleViewMode()">
                    <i class="fas fa-eye"></i> Ansicht wechseln
                </button>
                <button type="button" class="btn btn-warning" onclick="zoomToFit()">
                    <i class="fas fa-search"></i> Anpassen
                </button>
            </div>
        </div>
    </div>

    <!-- Gantt Chart Container -->
    <div class="row">
        <div class="col">
            <div class="card" style="margin-bottom:80px;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Gantt-Diagramm</h5>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" onclick="changeTimeScale('day')">Tag</button>
                        <button type="button" class="btn btn-outline-secondary active" onclick="changeTimeScale('week')">Woche</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="changeTimeScale('month')">Monat</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    @* <div id="gantt-container" style="height: 600px; overflow: hidden;"> *@
                    <div id="gantt-container">
                        <div class="gantt-wrapper">
                            <!-- Task List Panel -->
                            <div class="gantt-task-list">
                                <div class="gantt-header">
                                    <div class="task-name-header">Aufgabe</div>
                                    <div class="task-duration-header">Dauer</div>
                                    <div class="task-start-header">Start</div>
                                    <div class="task-end-header">Ende</div>
                                    <div class="task-actions-header">Aktionen</div>
                                </div>
                                <div id="task-list-body" class="gantt-task-list-body">
                                    <!-- Tasks will be populated here -->
                                </div>
                            </div>

                            <!-- Timeline Panel -->
                            <div class="gantt-timeline">
                                <div id="timeline-header" class="gantt-timeline-header">
                                    <!-- Timeline header will be generated -->
                                </div>
                                <div id="timeline-body" class="gantt-timeline-body">
                                    <!-- Timeline bars will be generated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Section Modal -->
<div class="modal fade" id="addSectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="CreateProjectSection">
                <div class="modal-header">
                    <h5 class="modal-title">Neuen Abschnitt hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="projectId" value="@Model.Project?.ProjectId" />
                    <div class="mb-3">
                        <label class="form-label">Abschnittsname</label>
                        <input type="text" class="form-control" name="Name" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Übergeordneter Abschnitt (optional)</label>
                        <select class="form-select" id="parentSectionSelect" name="parentSectionId">
                            <option value="">-- Hauptabschnitt --</option>
                            @if (Model.Project?.ProjectSections != null)
                            {
                                @foreach (var projectSection in Model.Project.ProjectSections.Where(s => s.ParentSectionId == null))
                                {
                                    <option value="@projectSection.ProjectSectionId">@projectSection.ProjectSectionName</option>
                                    @if (projectSection.SubSections != null)
                                    {
                                        @foreach (var subSection in projectSection.SubSections)
                                        {
                                            <option value="@subSection.ProjectSectionId">-- @subSection.ProjectSectionName</option>
                                        }
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Erstellen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="CreateProjectTask">
                <div class="modal-header">
                    <h5 class="modal-title">Neue Aufgabe hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Aufgabenname</label>
                        <input type="text" class="form-control" name="Name" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Abschnitt</label>
                        <select class="form-select" name="SectionId" required>
                            <option value="">-- Abschnitt auswählen --</option>
                            @if (Model.Project?.ProjectSections != null)
                            {
                                @foreach (var projectSection in Model.Project.ProjectSections.Where(s => s.ParentSectionId == null))
                                {
                                    <option value="@projectSection.ProjectSectionId">@projectSection.ProjectSectionName</option>
                                    @if (projectSection.SubSections != null)
                                    {
                                        @foreach (var subSection in projectSection.SubSections)
                                        {
                                            <option value="@subSection.ProjectSectionId">-- @subSection.ProjectSectionName</option>
                                        }
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Startdatum</label>
                            <input type="date" class="form-control" name="startDate" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Enddatum</label>
                            <input type="date" class="form-control" name="endDate" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Erstellen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="EditProjectTask">
                <div class="modal-header">
                    <h5 class="modal-title">Aufgabe bearbeiten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTaskId" name="taskId" />
                    <div class="mb-3">
                        <label class="form-label">Aufgabenname</label>
                        <input type="text" class="form-control" id="editTaskName" name="name" />
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Startdatum</label>
                            <input type="date" class="form-control" id="editTaskStartDate" name="startDate" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Enddatum</label>
                            <input type="date" class="form-control" id="editTaskEndDate" name="endDate" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="DeleteSelected">
                <div class="modal-header">
                    <h5 class="modal-title">Löschen bestätigen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmText">Sind Sie sicher, dass Sie dieses Element löschen möchten?</p>
                    <input type="hidden" id="deleteObjectJson" name="objectJson" />
                    <input type="hidden" name="Project.ProjectId" value="@Model.Project?.ProjectId" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-danger">Löschen</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
// Project data from server
const projectData = {
    project: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(new {
        Id = Model.Project?.ProjectId,
        Name = Model.Project?.ProjectName,
        StartDate = Model.Project?.StartDate?.ToString("yyyy-MM-dd"),
        EndDate = Model.Project?.EndDate?.ToString("yyyy-MM-dd"),
        Sections = Model.Project?.ProjectSections?.Where(s => s.ParentSectionId == null).Select(s => new {
            Id = s.ProjectSectionId,
            Name = s.ProjectSectionName,
            Type = "section",
            SubSections = s.SubSections?.Select(sub => new {
                Id = sub.ProjectSectionId,
                Name = sub.ProjectSectionName,
                Type = "subsection",
                Tasks = sub.ProjectTasks?.Select(t => new {
                    Id = t.ProjectTaskId,
                    Name = t.ProjectTaskName,
                    StartDate = t.StartDate?.ToString("yyyy-MM-dd"),
                    EndDate = t.EndDate?.ToString("yyyy-MM-dd"),
                    Type = "task"
                })
            }),
            Tasks = s.ProjectTasks?.Select(t => new {
                Id = t.ProjectTaskId,
                Name = t.ProjectTaskName,
                StartDate = t.StartDate?.ToString("yyyy-MM-dd"),
                EndDate = t.EndDate?.ToString("yyyy-MM-dd"),
                Type = "task"
            })
        })
    }))
};

let currentTimeScale = 'week';
let ganttStartDate = new Date();
let ganttEndDate = new Date();

document.addEventListener('DOMContentLoaded', function() {
    initializeGanttChart();
});

function initializeGanttChart() {
    calculateDateRange();
    renderTaskList();
    renderTimeline();
}

function calculateDateRange() {
    const today = new Date();
    ganttStartDate = new Date(today.getFullYear(), today.getMonth(), 1);
    ganttEndDate = new Date(today.getFullYear(), today.getMonth() + 6, 0);
    
    // Adjust based on project dates if available
    if (projectData.project.StartDate) {
        const projectStart = new Date(projectData.project.StartDate);
        if (projectStart < ganttStartDate) {
            ganttStartDate = new Date(projectStart.getFullYear(), projectStart.getMonth(), 1);
        }
    }
    
    if (projectData.project.EndDate) {
        const projectEnd = new Date(projectData.project.EndDate);
        if (projectEnd > ganttEndDate) {
            ganttEndDate = new Date(projectEnd.getFullYear(), projectEnd.getMonth() + 1, 0);
        }
    }
}

function renderTaskList() {
    const taskListBody = document.getElementById('task-list-body');
    taskListBody.innerHTML = '';
    
    if (!projectData.project.Sections) return;
    
    projectData.project.Sections.forEach(section => {
        renderTaskRow(section, taskListBody);
        
        if (section.SubSections) {
            section.SubSections.forEach(subSection => {
                renderTaskRow(subSection, taskListBody, true);
                
                if (subSection.Tasks) {
                    subSection.Tasks.forEach(task => {
                        renderTaskRow(task, taskListBody, false, true);
                    });
                }
            });
        }
        
        if (section.Tasks) {
            section.Tasks.forEach(task => {
                renderTaskRow(task, taskListBody, false, true);
            });
        }
    });
}

function renderTaskRow(item, container, isSubSection = false, isTask = false) {
    const row = document.createElement('div');
    row.className = `task-row ${item.Type}`;
    row.dataset.id = item.Id;
    row.dataset.type = item.Type;
    
    const duration = calculateDuration(item.StartDate, item.EndDate);
    const startDateStr = item.StartDate ? formatDate(item.StartDate) : '-';
    const endDateStr = item.EndDate ? formatDate(item.EndDate) : '-';
    
    row.innerHTML = `
        <div class="task-name">${item.Name}</div>
        <div class="task-duration">${duration}</div>
        <div class="task-start">${startDateStr}</div>
        <div class="task-end">${endDateStr}</div>
        <div class="task-actions">
            ${isTask ? `<button class="btn btn-sm btn-outline-primary me-1" onclick="editTask('${item.Id}', '${item.Name}', '${item.StartDate || ''}', '${item.EndDate || ''}')"><i class="fas fa-edit"></i></button>` : ''}
            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item.Id}', '${item.Type}', '${item.Name}')"><i class="fas fa-trash"></i></button>
        </div>
    `;
    
    container.appendChild(row);
}

function renderTimeline() {
    const timelineHeader = document.getElementById('timeline-header');
    const timelineBody = document.getElementById('timeline-body');
    
    timelineHeader.innerHTML = '';
    timelineBody.innerHTML = '';
    
    //renderTimelineHeader(timelineHeader);
    //renderTimelineBars(timelineBody);
    renderTimelineHeader(timelineHeader);
    renderVerticalGridLines(
        timelineBody,
        Math.ceil((ganttEndDate - ganttStartDate) / 86400000),
        40                       // gleicher Wert wie dayWidth
    );
    renderTimelineBars(timelineBody);
}

function renderTimelineHeader(container) {
    const totalDays = Math.ceil((ganttEndDate - ganttStartDate) / (1000 * 60 * 60 * 24));
    const dayWidth = 40; // pixels per day
    
    for (let i = 0; i <= totalDays; i += (currentTimeScale === 'day' ? 1 : currentTimeScale === 'week' ? 7 : 30)) {
        const date = new Date(ganttStartDate);
        date.setDate(date.getDate() + i);
        
        const headerDiv = document.createElement('div');
        headerDiv.className = 'timeline-header-day';
        headerDiv.style.left = (i * dayWidth) + 'px';
        headerDiv.style.width = (dayWidth * (currentTimeScale === 'day' ? 1 : currentTimeScale === 'week' ? 7 : 30)) + 'px';
        headerDiv.textContent = formatHeaderDate(date);
        
        container.appendChild(headerDiv);
    }
    
    container.style.width = (totalDays * dayWidth) + 'px';
}

function renderTimelineBars(container) {
    const totalDays = Math.ceil((ganttEndDate - ganttStartDate) / (1000 * 60 * 60 * 24));
    const dayWidth = 40;
    let rowIndex = 0;
    
    container.style.width = (totalDays * dayWidth) + 'px';
    container.style.height = (calculateTotalRows() * 40) + 'px';
    
    if (!projectData.project.Sections) return;
    
    projectData.project.Sections.forEach(section => {
        renderTimelineBar(section, container, rowIndex, dayWidth);
        rowIndex++;
        
        if (section.SubSections) {
            section.SubSections.forEach(subSection => {
                renderTimelineBar(subSection, container, rowIndex, dayWidth);
                rowIndex++;
                
                if (subSection.Tasks) {
                    subSection.Tasks.forEach(task => {
                        renderTimelineBar(task, container, rowIndex, dayWidth);
                        rowIndex++;
                    });
                }
            });
        }
        
        if (section.Tasks) {
            section.Tasks.forEach(task => {
                renderTimelineBar(task, container, rowIndex, dayWidth);
                rowIndex++;
            });
        }
    });
}


function renderTimelineBar(item, container, rowIndex, dayWidth) {
    if (!item.StartDate || !item.EndDate) return;
    
    const startDate = new Date(item.StartDate);
    const endDate = new Date(item.EndDate);
    
    const startOffset = Math.max(0, Math.ceil((startDate - ganttStartDate) / (1000 * 60 * 60 * 24)));
    const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    const bar = document.createElement('div');
    bar.className = `timeline-bar ${item.Type}`;
    bar.style.left = (startOffset * dayWidth) + 'px';
    bar.style.width = (duration * dayWidth - 4) + 'px';
    bar.style.top = (rowIndex * 40 + 10) + 'px'; // 10px offset to center in 40px row
    bar.textContent = item.Name;
    bar.title = `${item.Name} (${formatDate(item.StartDate)} - ${formatDate(item.EndDate)})`;
    
    container.appendChild(bar);
}


    function renderVerticalGridLines(container, totalDays, dayWidth) {
        // Alte Linien entfernen (beim Neurendern)
        container.querySelectorAll('.timeline-grid-line').forEach(el => el.remove());

        // Schrittweite wie im Header
        const step = currentTimeScale === 'day'  ? 1  :
                     currentTimeScale === 'week' ? 7  : 30;

        for (let i = 0; i <= totalDays; i += step) {
            const line = document.createElement('div');
            line.className = 'timeline-grid-line';
            line.style.left = (i * dayWidth) + 'px';
            container.appendChild(line);
        }
    }


function calculateTotalRows() {
    if (!projectData.project.Sections) return 0;
    
    let count = 0;
    projectData.project.Sections.forEach(section => {
        count++; // section itself
        if (section.SubSections) {
            section.SubSections.forEach(subSection => {
                count++; // subsection
                if (subSection.Tasks) {
                    count += subSection.Tasks.length; // tasks in subsection
                }
            });
        }
        if (section.Tasks) {
            count += section.Tasks.length; // tasks in section
        }
    });
    
    return count;
}

function calculateDuration(startDate, endDate) {
    if (!startDate || !endDate) return '-';
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    
    return days + 'd';
}

function formatDate(dateString) {
    if (!dateString) return '-';
    
    const date = new Date(dateString);
    return date.toLocaleDateString('de-DE');
}

function formatHeaderDate(date) {
    switch (currentTimeScale) {
        case 'day':
            return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
        case 'week':
            return `KW ${getWeekNumber(date)}`;
        case 'month':
            return date.toLocaleDateString('de-DE', { month: 'short', year: '2-digit' });
        default:
            return date.toLocaleDateString('de-DE');
    }
}

function getWeekNumber(date) {
    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

// Modal functions
function showAddSectionModal() {
    new bootstrap.Modal(document.getElementById('addSectionModal')).show();
}

function showAddTaskModal() {
    new bootstrap.Modal(document.getElementById('addTaskModal')).show();
}

function editTask(taskId, taskName, startDate, endDate) {
    document.getElementById('editTaskId').value = taskId;
    document.getElementById('editTaskName').value = taskName;
    document.getElementById('editTaskStartDate').value = startDate;
    document.getElementById('editTaskEndDate').value = endDate;
    
    new bootstrap.Modal(document.getElementById('editTaskModal')).show();
}

function deleteItem(itemId, itemType, itemName) {
    document.getElementById('deleteConfirmText').textContent = 
        `Sind Sie sicher, dass Sie "${itemName}" löschen möchten?`;
    
    const jsonData = {
        Type: itemType === 'task' ? 'ProjectTask' : 'ProjectSection',
        Data: { itemId, itemName }
    // const jsonData = {
    //     Type: itemType === 'task' ? 'ProjectTask' : 'ProjectSection',
    //     Data: itemType === 'task' ? 
    //         { ProjectTaskId: itemId } : 
    //         { ProjectSectionId: itemId }
    };
    
    // document.getElementById('deleteObjectJson').value = jsonData;
    document.getElementById('deleteObjectJson').value = JSON.stringify(jsonData);
    
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function changeTimeScale(scale) {
    currentTimeScale = scale;
    
    // Update active button
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderTimeline();
}

function toggleViewMode() {
    // Toggle between different view modes (could be expanded)
    alert('Ansichtsmodus-Funktion kann hier implementiert werden');
}

function zoomToFit() {
    calculateDateRange();
    renderTimeline();
}
</script>

<!-- Include Bootstrap and FontAwesome if not already included -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="/css/gantt.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

@* @page "{id}"
@model SAAS_Projectplanningtool.Pages.Projects.EditModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using System.Text.Json
@using SAAS_Projectplanningtool.Pages.Projects
@{
    ViewData["Title"] = "Projekt‑Zeitplanung";

    /**********************************************************************
    * Build a combined task list (Sections **and** Tasks) for Frappe‑Gantt
    **********************************************************************/
    var ganttTasks = new List<object>();

    (DateOnly? start, DateOnly? end) WalkSection(
        SAAS_Projectplanningtool.Models.Budgetplanning.ProjectSection sec,
        string path)
    {
        var currentPath = string.IsNullOrEmpty(path)
            ? sec.ProjectSectionName
            : $"{path} / {sec.ProjectSectionName}";

        DateOnly? earliest = null;
        DateOnly? latest = null;

        // ---------- Tasks in this section ----------
        if (sec.ProjectTasks != null)
        {
            foreach (var t in sec.ProjectTasks)
            {
                if (t.StartDate != null && t.EndDate != null)
                {
                    earliest = earliest == null || t.StartDate < earliest ? t.StartDate : earliest;
                    latest = latest == null || t.EndDate > latest ? t.EndDate : latest;

                    ganttTasks.Add(new
                    {
                        id = t.ProjectTaskId,
                        name = $"{currentPath} / {t.ProjectTaskName}",
                        start = t.StartDate!.Value.ToDateTime(new TimeOnly(0)).ToString("yyyy-MM-dd"),
                        end = t.EndDate!.Value.ToDateTime(new TimeOnly(0)).ToString("yyyy-MM-dd"),
                        progress = 0,
                        dependencies = string.Empty,
                        custom_class = "task-bar"
                    });
                }
            }
        }

        // ---------- Recurse into subsections ----------
        if (sec.SubSections != null)
        {
            foreach (var child in sec.SubSections)
            {
                var (childStart, childEnd) = WalkSection(child, currentPath);
                earliest = childStart != null && (earliest == null || childStart < earliest) ? childStart : earliest;
                latest = childEnd != null && (latest == null || childEnd > latest) ? childEnd : latest;
            }
        }

        // ---------- Represent the section itself ----------
        if (earliest != null && latest != null)
        {
            ganttTasks.Add(new
            {
                id = $"S_{sec.ProjectSectionId}",
                name = currentPath,
                start = earliest.Value.ToDateTime(new TimeOnly(0)).ToString("yyyy-MM-dd"),
                end = latest.Value.ToDateTime(new TimeOnly(0)).ToString("yyyy-MM-dd"),
                progress = 0,
                dependencies = string.Empty,
                custom_class = "section-bar"
            });
        }

        return (earliest, latest);
    }

    if (Model.Project.ProjectSections != null)
    {
        foreach (var root in Model.Project.ProjectSections)
        {
            WalkSection(root, string.Empty);
        }
    }

    var tasksJson = JsonSerializer.Serialize(ganttTasks);
}

<h2 class="mb-4">@Model.Project.ProjectName – Zeitplanung</h2>
<!-- TEST: Delete Fehlerhandling-->
@{
    var message = TempData.GetMessage();
}
@if (message != null)
{
    <div class="alert alert-@message.Type.ToLower()">
        @message.Message
    </div>
}

<!-- ================= Abschnitt anlegen ================= -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <form method="post" asp-page-handler="CreateProjectSection" class="row gy-2 gx-3 align-items-center">
            <input type="hidden" name="projectId" value="@Model.Project.ProjectId" />
            <input type="hidden" name="Project.ProjectId" value="@Model.Project.ProjectId" />
            <div class="col-sm-9">
                <input name="Name" class="form-control" placeholder="Neuen Abschnitt anlegen" required />
            </div>
            <div class="col-sm-3 d-grid">
                <button class="btn btn-primary w-100" type="submit">Abschnitt hinzufügen</button>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <!-- ================= Baumstruktur ================= -->
    <div class="col-lg-4 mb-4">
        <h4>Struktur</h4>
        <ul class="list-group" id="sectionTree">
            @{
                ViewData["ProjectId"] = Model.Project.ProjectId;
            }
            @foreach (var section in Model.Project.ProjectSections ?? Enumerable.Empty<SAAS_Projectplanningtool.Models.Budgetplanning.ProjectSection>())
            {
                <partial name="_SectionNode" model="section" view-data="@ViewData" />

            }
        </ul>
    </div>

    <!-- ================= Gantt‑Diagramm ================= -->
    <div class="col-lg-8">
        <h4>Gantt</h4>
        <div id="gantt" style="width: 100%; height: 600px;"></div>
    </div>
</div>

<link href="https://unpkg.com/frappe-gantt@0.6.0/dist/frappe-gantt.css" rel="stylesheet" />
<script src="https://unpkg.com/frappe-gantt@0.6.0/dist/frappe-gantt.js"></script>

<style>
    .bar.section-bar {
        fill: #6c757d;
        rx: 6px;
        ry: 6px;
    }

    .bar.task-bar {
        rx: 4px;
        ry: 4px;
    }
</style>

<script>
    const tasks = @Html.Raw(tasksJson);
    console.log('Gantt‑Tasks', tasks); // Debug‑Hilfe
    const gantt = new Gantt("#gantt", tasks, { view_mode: "Day", language: "de" });
</script>


 *@