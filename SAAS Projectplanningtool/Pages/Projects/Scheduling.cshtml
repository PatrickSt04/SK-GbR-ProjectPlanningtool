@page
@using SAAS_Projectplanningtool.Pages.Projects
@model SAAS_Projectplanningtool.Pages.Projects.EditModel
@{
    ViewData["Title"] = "Projektterminplanung - " + Model.Project?.ProjectName;
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>@ViewData["Title"]</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-page="./Index">Projekte</a></li>
                    <li class="breadcrumb-item active">Terminplanung</li>
                </ol>
            </nav>
        </div>
    </div>
    <!--  Feedbackhandling (should only be displayed for certain amount of seconds)-->
    @{
        var message = TempData.GetMessage();
    }
    @if (message != null)
    {
        <div class="alert alert-@message.Type.ToLower()" id="feedback-message">
            @message.Message
        </div>

        <script>
            setTimeout(function () {
                var msg = document.getElementById('feedback-message');
                if (msg) {
                    msg.style.transition = "opacity 0.5s ease";
                    msg.style.opacity = 0;
                    setTimeout(() => msg.remove(), 500); // Remove after fade
                }
            }, 3000); // Display for 3 seconds
        </script>
    }

    <!-- Toolbar -->
    <div class="row mb-3">
        <div class="col">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="showAddSectionModal()">
                    <i class="fas fa-plus"></i> Abschnitt hinzufügen
                </button>
                <button type="button" class="btn btn-secondary" onclick="showAddTaskModal()">
                    <i class="fas fa-tasks"></i> Aufgabe hinzufügen
                </button>
                <button type="button" class="btn btn-info" onclick="toggleViewMode()">
                    <i class="fas fa-eye"></i> Ansicht wechseln
                </button>
                <button type="button" class="btn btn-warning" onclick="zoomToFit()">
                    <i class="fas fa-search"></i> Anpassen
                </button>
            </div>
        </div>
    </div>

    <!-- Gantt Chart Container -->
    <div class="row">
        <div class="col">
            <div class="card" style="margin-bottom:80px;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Gantt-Diagramm</h5>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" onclick="changeTimeScale('day')">Tag</button>
                        <button type="button" class="btn btn-outline-secondary active" onclick="changeTimeScale('week')">Woche</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="changeTimeScale('month')">Monat</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    @* <div id="gantt-container" style="height: 600px; overflow: hidden;"> *@
                    <div id="gantt-container">
                        <div class="gantt-wrapper">
                            <!-- Task List Panel -->
                            <div class="gantt-task-list">
                                <div class="gantt-header">
                                    <div class="task-name-header">Aufgabe</div>
                                    <div class="task-duration-header">Dauer</div>
                                    <div class="task-start-header">Start</div>
                                    <div class="task-end-header">Ende</div>
                                    <div class="task-actions-header">Aktionen</div>
                                </div>
                                <div id="task-list-body" class="gantt-task-list-body">
                                    <!-- Tasks will be populated here -->
                                </div>
                            </div>

                            <!-- Timeline Panel -->
                            <div class="gantt-timeline">
                                <div id="timeline-header" class="gantt-timeline-header">
                                    <!-- Timeline header will be generated -->
                                </div>
                                <div id="timeline-body" class="gantt-timeline-body">
                                    <!-- Timeline bars will be generated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Section Modal -->
<div class="modal fade" id="addSectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="CreateProjectSection">
                <div class="modal-header">
                    <h5 class="modal-title">Neuen Abschnitt hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="projectId" value="@Model.Project?.ProjectId" />
                    <div class="mb-3">
                        <label class="form-label">Abschnittsname</label>
                        <input type="text" class="form-control" name="Name" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Übergeordneter Abschnitt (optional)</label>
                        <select class="form-select" id="parentSectionSelect" name="parentSectionId">
                            <option value="">-- Hauptabschnitt --</option>
                            @if (Model.Project?.ProjectSections != null)
                            {
                                @foreach (var projectSection in Model.Project.ProjectSections.Where(s => s.ParentSectionId == null))
                                {
                                    <option value="@projectSection.ProjectSectionId">@projectSection.ProjectSectionName</option>
                                    @if (projectSection.SubSections != null)
                                    {
                                        @foreach (var subSection in projectSection.SubSections)
                                        {
                                            <option value="@subSection.ProjectSectionId">-- @subSection.ProjectSectionName</option>
                                        }
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Erstellen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="CreateProjectTask">

                <div class="modal-header">
                    <h5 class="modal-title">Neue Aufgabe hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Aufgabenname</label>
                        <input type="text" class="form-control" name="Name" required />
                        <input type="hidden" name="projectId" value="@Model.Project.ProjectId" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Abschnitt</label>
                        <select class="form-select" id="taskSectionSelect" name="SectionId" required>
                            <option value="">-- Abschnitt auswählen --</option>
                            @if (Model.Project?.ProjectSections != null)
                            {
                                @foreach (var projectSection in Model.Project.ProjectSections.Where(s => s.ParentSectionId == null))
                                {
                                    <option value="@projectSection.ProjectSectionId">@projectSection.ProjectSectionName</option>
                                    @if (projectSection.SubSections != null)
                                    {
                                        @foreach (var subSection in projectSection.SubSections)
                                        {
                                            <option value="@subSection.ProjectSectionId">-- @subSection.ProjectSectionName</option>
                                        }
                                    }
                                }
                            }
                        </select>

                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Startdatum</label>
                            <input type="date" class="form-control" name="startDate" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Enddatum</label>
                            <input type="date" class="form-control" name="endDate" />
                        </div>
                    </div>
                    @*HINZUGEFÜGT: In Aufgabenkatalog übernehmen*@
<input asp-for="IsTaskCatalogEntry" value="true" class="form-check-input" /> 
<label asp-for="IsTaskCatalogEntry" class="form-check-label">Als Katalogeintrag speichern</label>
4

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Erstellen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Item Modal  (Auswahl: Aufgabe | Unterabschnitt) -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Was möchten Sie anlegen?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body d-grid gap-3">
                <button id="chooseTaskBtn" class="btn btn-outline-success btn-lg">
                    <i class="fas fa-tasks me-2"></i> Aufgabe
                </button>

                <button id="chooseSubBtn" class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-sitemap me-2"></i> Unterabschnitt
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Add Sub-Section Modal  -->
<div class="modal fade" id="addSubSectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="CreateProjectSection">
                <div class="modal-header">
                    <h5 class="modal-title">Neuen Unterabschnitt hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    <input type="hidden" name="projectId" value="@Model.Project.ProjectId" />
                </div>

                <div class="modal-body">
                    <!-- über JS gefüllt -->
                    <input type="hidden" id="parentSubSectionId" name="parentSectionId" />

                    <div class="mb-3">
                        <label class="form-label">Unterabschnittsname</label>
                        <input type="text" class="form-control" name="Name" required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Erstellen</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="EditProjectTask">
                <div class="modal-header">
                    <h5 class="modal-title">Aufgabe bearbeiten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTaskId" name="taskId" />
                    <input type="hidden" name="projectId" value="@Model.Project.ProjectId" />
                    <div class="mb-3">
                        <label class="form-label">Aufgabenname</label>
                        <input type="text" class="form-control" id="editTaskName" name="name" />
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Startdatum</label>
                            <input type="date" class="form-control" id="editTaskStartDate" name="startDate" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Enddatum</label>
                            <input type="date" class="form-control" id="editTaskEndDate" name="endDate" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="DeleteSelected">
                <div class="modal-header">
                    <h5 class="modal-title">Löschen bestätigen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmText">Sind Sie sicher, dass Sie dieses Element löschen möchten?</p>
                    <input type="hidden" id="deleteObjectJson" name="objectJson" />
                    <input type="hidden" name="Project.ProjectId" value="@Model.Project?.ProjectId" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-danger">Löschen</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>

    document.addEventListener('click', e=>{
        if (e.target.classList.contains('caret')){
            e.stopPropagation();                    // keine Zeilen-Clicks auslösen
            toggleCollapse(e.target.dataset.id);
        }
    });

    const collapsed = new Map();

    const projectData = {
        project: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(new
        {
            Id = Model.Project?.ProjectId,
            Name = Model.Project?.ProjectName,
            StartDate = Model.Project?.StartDate?.ToString("yyyy-MM-dd"),
            EndDate = Model.Project?.EndDate?.ToString("yyyy-MM-dd"),
            Sections = Model.Project?.ProjectSections?.Where(s => s.ParentSectionId == null).Select(s => new
            {
                Id = s.ProjectSectionId,
                Name = s.ProjectSectionName,
                Type = "section",
                SubSections = s.SubSections?.Select(sub => new
                {
                    Id = sub.ProjectSectionId,
                    Name = sub.ProjectSectionName,
                    Type = "subsection",
                    Tasks = sub.ProjectTasks?.Select(t => new
                    {
                        Id = t.ProjectTaskId,
                        Name = t.ProjectTaskName,
                        StartDate = t.StartDate?.ToString("yyyy-MM-dd"),
                        EndDate = t.EndDate?.ToString("yyyy-MM-dd"),
                        Type = "task"
                    })
                }),
                Tasks = s.ProjectTasks?.Select(t => new
                {
                    Id = t.ProjectTaskId,
                    Name = t.ProjectTaskName,
                    StartDate = t.StartDate?.ToString("yyyy-MM-dd"),
                    EndDate = t.EndDate?.ToString("yyyy-MM-dd"),
                    Type = "task"
                })
            })
        }))
    };

    let currentTimeScale = 'week';
    let ganttStartDate = new Date();
    let ganttEndDate = new Date();

    document.addEventListener('DOMContentLoaded', function() {
        initializeGanttChart();
    });

    function preloadCollapse(){
        function walk(node){
            if(node.Type !== 'task'){                  // nur Section/Subsection
                collapsed.set(node.Id, true);         // ← als eingeklappt merken
                if(node.SubSections) node.SubSections.forEach(walk);
            }
        }
        projectData.project.Sections?.forEach(walk);
    }

    function initializeGanttChart() {
        calculateDateRange();
        preloadCollapse();
        renderTaskList();
        renderTimeline();
    }

    function calculateDateRange() {
        const today = new Date();
        ganttStartDate = new Date(today.getFullYear(), today.getMonth(), 1);
        ganttEndDate = new Date(today.getFullYear(), today.getMonth() + 6, 0);

        // Adjust based on project dates if available
        if (projectData.project.StartDate) {
            const projectStart = new Date(projectData.project.StartDate);
            if (projectStart < ganttStartDate) {
                ganttStartDate = new Date(projectStart.getFullYear(), projectStart.getMonth(), 1);
            }
        }

        if (projectData.project.EndDate) {
            const projectEnd = new Date(projectData.project.EndDate);
            if (projectEnd > ganttEndDate) {
                ganttEndDate = new Date(projectEnd.getFullYear(), projectEnd.getMonth() + 1, 0);
            }
        }
    }

    function isCollapsed(id){
        return collapsed.has(id) && collapsed.get(id);   // true | false
    }


    function toggleCollapse(id){
        collapsed.set(id, !isCollapsed(id));
        renderTaskList();
        renderTimeline();
    }

    /* Ermittelt frühesten Start / spätestes Ende unterhalb eines Knotens */
    function getDateRange(node){
        let min = node.StartDate ? new Date(node.StartDate) : null;
        let max = node.EndDate   ? new Date(node.EndDate)   : null;

        if(node.SubSections){
            node.SubSections.forEach(sub=>{
                const [s,e] = getDateRange(sub);
                if(s && (!min || s<min)) min=s;
                if(e && (!max || e>max)) max=e;
            });
        }
        if(node.Tasks){
            node.Tasks.forEach(t=>{
                if(t.StartDate){
                    const d=new Date(t.StartDate);
                    if(!min || d<min) min=d;
                }
                if(t.EndDate){
                    const d=new Date(t.EndDate);
                    if(!max || d>max) max=d;
                }
            });
        }
        return [min,max];
    }

    function renderTaskList() {
        // const body = document.getElementById('task-list-body');
        // body.innerHTML = '';

        // if (!projectData.project.Sections) return;

        // projectData.project.Sections.forEach(sec => walk(sec, 0));

        const body=document.getElementById('task-list-body');
        body.innerHTML='';

        if(!projectData.project.Sections) return;
        projectData.project.Sections.forEach(sec=>walk(sec,0));

        /* Footer-Adder ganz unten */
        const footer = document.createElement('div');
        footer.className = 'task-row adder-row';
        footer.dataset.level = 0;
        footer.innerHTML = `
             <div class="task-name">
                <button class="btn btn-sm btn-outline-primary"
                        onclick="showAddSectionModal()">
                   <i class="fas fa-plus"></i> Neuer Abschnitt
                </button>
             </div>`;
        body.appendChild(footer);

        // ---------- rekursive Hilfsfunktion ----------
        function walk(node, depth){
            renderTaskRow(node, body, depth);

            if(node.Type==='task' || isCollapsed(node.Id)) return;

            // Inline-Adder hinter jedem Nicht-Task
            if(node.Type !== 'task'){
                const adder = document.createElement('div');
                adder.className = 'task-row adder-row';
                adder.style.setProperty('--lvl', depth);      // ⬅︎  ebenfalls!
                adder.innerHTML = `
                   <div class="task-name">
                      <button class="btn btn-sm btn-outline-primary"
                              onclick="showAddItemModal('${node.Id}','${node.Type}')">
                          <i class="fas fa-plus"></i>
                      </button>
                   </div>`;
                body.appendChild(adder);
            }

            // ---------- rekursiv weiterlaufen ----------
            if (node.SubSections){
                node.SubSections.forEach(sub => walk(sub, depth+1));
            }
            if (node.Tasks){
                node.Tasks.forEach(t => walk(t, depth+1));
            }
        }
    }

    function renderTaskRow(item, container, depth){
        /* Grundgerüst */
        const row = document.createElement('div');
        row.className = `task-row ${item.Type}`;
        row.style.setProperty('--lvl', depth);
        row.dataset.id   = item.Id;
        row.dataset.type = item.Type;

        /* ⬇︎  NEU: Datenbereich ermitteln  --------------------------- */
        let start = item.StartDate;
        let end   = item.EndDate;

        if(item.Type !== 'task'){                   // Section / Subsection
            const [min, max] = getDateRange(item);  // rekursive Suche
            if(min && max){
                start = min.toISOString().slice(0,10);   // "yyyy-mm-dd"
                end   = max.toISOString().slice(0,10);
            }
        }

        const duration = (start && end) ? calculateDuration(start, end) : '-';
        const startStr = start ? formatDate(start) : '-';
        const endStr   = end   ? formatDate(end)   : '-';

        /* Pfeil & Aktionen bleiben wie zuvor ------------------------ */
        const hasChildren =
            (item.SubSections && item.SubSections.length) ||
            (item.Tasks       && item.Tasks.length);

        const folded = isCollapsed(item.Id);
        const caret  = hasChildren
            ? `<i class="fas fa-caret-down caret ${folded ? 'collapsed' : ''}"
                  data-id="${item.Id}"></i>`
            : '';

        const isTask = item.Type === 'task';

        row.innerHTML = `
            <div class="task-name">${caret}${item.Name}</div>
            <div class="task-duration">${duration}</div>
            <div class="task-start">${startStr}</div>
            <div class="task-end">${endStr}</div>
            <div class="task-actions">
                ${isTask ? `
                    <button class="btn btn-sm btn-outline-primary me-1"
                            onclick="editTask('${item.Id}', '${item.Name}',
                                              '${item.StartDate || ''}', '${item.EndDate || ''}')">
                        <i class="fas fa-edit"></i>
                    </button>` : ''}
                <button class="btn btn-sm btn-outline-danger"
                        onclick="deleteItem('${item.Id}', '${item.Type}', '${item.Name}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>`;
        container.appendChild(row);
    }



    function showAddSubSectionModal(parentId){
       document.getElementById('parentSubSectionId').value = parentId;
       new bootstrap.Modal(document.getElementById('addSubSectionModal')).show();
    }

    function renderTimeline() {
        const timelineHeader = document.getElementById('timeline-header');
        const timelineBody = document.getElementById('timeline-body');

        timelineHeader.innerHTML = '';
        timelineBody.innerHTML = '';

        //renderTimelineHeader(timelineHeader);
        //renderTimelineBars(timelineBody);
        renderTimelineHeader(timelineHeader);
        renderVerticalGridLines(
            timelineBody,
            Math.ceil((ganttEndDate - ganttStartDate) / 86400000),
            40                       // gleicher Wert wie dayWidth
        );
        renderTimelineBars(timelineBody);
    }

    function renderTimelineHeader(container) {
        const totalDays = Math.ceil((ganttEndDate - ganttStartDate) / (1000 * 60 * 60 * 24));
        const dayWidth = 48; // pixels per day

        for (let i = 0; i <= totalDays; i += (currentTimeScale === 'day' ? 1 : currentTimeScale === 'week' ? 7 : 30)) {
            const date = new Date(ganttStartDate);
            date.setDate(date.getDate() + i);

            const headerDiv = document.createElement('div');
            headerDiv.className = 'timeline-header-day';
            headerDiv.style.left = (i * dayWidth) + 'px';
            headerDiv.style.width = (dayWidth * (currentTimeScale === 'day' ? 1 : currentTimeScale === 'week' ? 7 : 30)) + 'px';
            headerDiv.textContent = formatHeaderDate(date);

            container.appendChild(headerDiv);
        }

        container.style.width = (totalDays * dayWidth) + 'px';
    }

    function renderTimelineBars(container){
        const totalDays=Math.ceil((ganttEndDate-ganttStartDate)/86400000);
        const dayWidth=48;
        let row=0;
        container.style.width=(totalDays*dayWidth)+'px';
        container.style.height=(calculateTotalRows()*40)+'px';

        if(!projectData.project.Sections) return;
        projectData.project.Sections.forEach(sec=>walk(sec,0));

        /* ---------- rekursiv ---------- */
        function walk(node,depth){
            // const isCollapsed=collapsed.get(node.Id);
            const fold = isCollapsed(node.Id)

            if(node.Type!=='task' && fold){
                const [min,max]=getDateRange(node);
                if(min&&max) drawBar(node,min,max,row,dayWidth,'fold');
                row++;                              // eigene Zeile
                return;                             // Kinder überspringen
            }

            if(node.StartDate&&node.EndDate)
                drawBar(node,new Date(node.StartDate),new Date(node.EndDate),row,dayWidth,node.Type);
            row++;                                  // eigene Zeile

            if(node.Type!=='task'){
                /* Adder-Row überspringen => +1 */
                row++;
                if(node.SubSections) node.SubSections.forEach(sub=>walk(sub,depth+1));
                if(node.Tasks)       node.Tasks.forEach(t  =>walk(t,  depth+1));
            }
        }

        function drawBar(item,startDate,endDate,r,dayWidth,extraClass=''){
            const startOff=Math.max(0,Math.ceil((startDate-ganttStartDate)/86400000));
            const dur=Math.ceil((endDate-startDate)/86400000)+1;

            const bar=document.createElement('div');
            bar.className=`timeline-bar ${item.Type} ${extraClass}`;
            bar.style.left =(startOff*dayWidth)+'px';
            bar.style.width=(dur*dayWidth-4)+'px';
            bar.style.top  =(r*40+10)+'px';
            bar.textContent=item.Name;
            container.appendChild(bar);
        }
    }


    function renderTimelineBar(item, container, rowIndex, dayWidth) {
        if (!item.StartDate || !item.EndDate) return;

        const startDate = new Date(item.StartDate);
        const endDate = new Date(item.EndDate);

        const startOffset = Math.max(0, Math.ceil((startDate - ganttStartDate) / (1000 * 60 * 60 * 24)));
        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

        const bar = document.createElement('div');
        bar.className = `timeline-bar ${item.Type}`;
        bar.style.left = (startOffset * dayWidth) + 'px';
        bar.style.width = (duration * dayWidth - 4) + 'px';
        bar.style.top = (rowIndex * 40 + 10) + 'px'; // 10px offset to center in 40px row
        bar.textContent = item.Name;
        bar.title = `${item.Name} (${formatDate(item.StartDate)} - ${formatDate(item.EndDate)})`;

        container.appendChild(bar);
    }


        function renderVerticalGridLines(container, totalDays, dayWidth) {
            // Alte Linien entfernen (beim Neurendern)
            container.querySelectorAll('.timeline-grid-line').forEach(el => el.remove());

            // Schrittweite wie im Header
            const step = currentTimeScale === 'day'  ? 1  :
                         currentTimeScale === 'week' ? 7  : 30;

            for (let i = 0; i <= totalDays; i += step) {
                const line = document.createElement('div');
                line.className = 'timeline-grid-line';
                line.style.left = (i * dayWidth) + 'px';
                container.appendChild(line);
            }
        }


    function calculateTotalRows(){
        let rows=1;                                // Footer
        if(!projectData.project.Sections) return rows;

        function walk(node){
            rows++;                                // eigene Zeile
            if(node.Type==='task') return;         // fertig

            if(collapsed.get(node.Id)) return;     // Kinder versteckt

            rows++;                                // Adder
            if(node.SubSections) node.SubSections.forEach(walk);
            if(node.Tasks)       node.Tasks.forEach(walk);
        }
        projectData.project.Sections.forEach(walk);
        return rows;
    }


    function calculateDuration(startDate, endDate) {
        if (!startDate || !endDate) return '-';

        const start = new Date(startDate);
        const end = new Date(endDate);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

        return days + 'd';
    }

    function formatDate(dateString) {
        if (!dateString) return '-';

        const date = new Date(dateString);
        return date.toLocaleDateString('de-DE');
    }

    function formatHeaderDate(date) {
        switch (currentTimeScale) {
            case 'day':
                return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            case 'week':
                return `KW ${getWeekNumber(date)}`;
            case 'month':
                return date.toLocaleDateString('de-DE', { month: 'short', year: '2-digit' });
            default:
                return date.toLocaleDateString('de-DE');
        }
    }

    function getWeekNumber(date) {
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }

    // Modal functions
    function showAddSectionModal() {
        new bootstrap.Modal(document.getElementById('addSectionModal')).show();
    }

    function showAddTaskModal(sectionId = null) {
        // Section-Dropdown im Modal auf gewünschten Abschnitt setzen
        if (sectionId){
            const sel = document.getElementById('taskSectionSelect');
            if (sel) sel.value = sectionId;
        }

        // Modal anzeigen
        new bootstrap.Modal(document.getElementById('addTaskModal')).show();
    }

    function editTask(taskId, taskName, startDate, endDate) {
        document.getElementById('editTaskId').value = taskId;
        document.getElementById('editTaskName').value = taskName;
        document.getElementById('editTaskStartDate').value = startDate;
        document.getElementById('editTaskEndDate').value = endDate;

        new bootstrap.Modal(document.getElementById('editTaskModal')).show();
    }

    function deleteItem(itemId, itemType, itemName) {
        document.getElementById('deleteConfirmText').textContent =
            `Sind Sie sicher, dass Sie "${itemName}" löschen möchten?`;

        const jsonData = {
            Type: itemType === 'task' ? 'ProjectTask' : 'ProjectSection',
            Data: { itemId, itemName }
        };

        // document.getElementById('deleteObjectJson').value = jsonData;
        document.getElementById('deleteObjectJson').value = JSON.stringify(jsonData);

        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    function changeTimeScale(scale) {
        currentTimeScale = scale;

        // Update active button
        document.querySelectorAll('.btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        renderTimeline();
    }

    function toggleViewMode() {
        // Toggle between different view modes (could be expanded)
        alert('Ansichtsmodus-Funktion kann hier implementiert werden');
    }

    function zoomToFit() {
        calculateDateRange();
        renderTimeline();
    }

        /* ------------------------------
       Globale Hilfs-Variablen
    --------------------------------*/
    let addItemParentId   = null;
    let addItemParentType = null;

    /* Öffnet das Auswahl-Modal */
    function showAddItemModal(parentId, parentType){
        addItemParentId   = parentId;
        addItemParentType = parentType;

        // „Unterabschnitt“ nur erlauben, wenn das Parent ein Section ist
        const subBtn = document.getElementById('chooseSubBtn');
        subBtn.disabled = (parentType !== 'section');

        new bootstrap.Modal(document.getElementById('addItemModal')).show();
    }

    /* Klick-Handler erst registrieren, wenn DOM fertig */
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('chooseTaskBtn').addEventListener('click', () => {
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
            showAddTaskModal(addItemParentId);        // existiert bereits
        });

        document.getElementById('chooseSubBtn').addEventListener('click', () => {
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
            showAddSubSectionModal(addItemParentId);  // existiert bereits
        });
    });

</script>

<!-- Include Bootstrap and FontAwesome if not already included -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="/css/gantt.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
