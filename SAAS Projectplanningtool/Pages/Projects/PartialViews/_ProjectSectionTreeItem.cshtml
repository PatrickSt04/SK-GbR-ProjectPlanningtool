@model SAAS_Projectplanningtool.Models.Budgetplanning.ProjectSection

<div class="structure-item structure-section" data-section-id="@Model.ProjectSectionId">
    <div class="structure-header" onclick="toggleSection(this)">
        <div class="structure-toggle">
            <i class="fas fa-chevron-right toggle-icon"></i>
            <i class="fas fa-folder"></i>
        </div>
        <div class="structure-content">
            <span class="structure-name">@Model.ProjectSectionName</span>
            <span class="structure-meta">
                @{
                    int taskCount = Model.ProjectTasks?.Count ?? 0;
                    int subSectionCount = Model.SubSections?.Count ?? 0;
                }
                @if (taskCount > 0)
                {
                    <span>@taskCount Task(s)</span>
                }
                @if (subSectionCount > 0)
                {
                    <span>@subSectionCount Subsection(s)</span>
                }
            </span>
        </div>
    </div>

    <div class="structure-children" style="display: none;">
        <!-- SubSections -->
        @if (Model.SubSections != null && Model.SubSections.Any())
        {
            @foreach (var subSection in Model.SubSections)
            {
                @await Html.PartialAsync("~/Pages/Projects/PartialViews/_ProjectSectionTreeItem.cshtml", subSection)
            }
        }

        <!-- Tasks -->
        @if (Model.ProjectTasks != null && Model.ProjectTasks.Any())
        {
            @foreach (var task in Model.ProjectTasks)
            {
                <div class="structure-item structure-task">
                    <div class="structure-header">
                        <div class="structure-toggle">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="structure-content">
                            <span class="structure-name">@task.ProjectTaskName</span>
                            <span class="structure-meta">
                                @if (task.StartDate.HasValue && task.EndDate.HasValue)
                                {
                                    <span class="task-dates">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        @task.StartDate.Value.ToString("dd.MM") - @task.EndDate.Value.ToString("dd.MM")
                                    </span>
                                }
                            </span>
                        </div>
                        <div class="structure-actions">
                            <!-- Status Badge with Dropdown -->
                            <div class="status-dropdown-container">
                                @if (task.State != null)
                                {
                                    <button type="button"
                                            class="status-badge-button"
                                            style="background-color: @task.State.Color;"
                                            onclick="toggleStatusDropdown(event, '@task.ProjectTaskId')">
                                        @task.State.StateName
                                        <i class="fas fa-chevron-down ms-1"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="button"
                                            class="status-badge-button status-badge-empty"
                                            onclick="toggleStatusDropdown(event, '@task.ProjectTaskId')">
                                        <em>Kein Status</em>
                                        <i class="fas fa-chevron-down ms-1"></i>
                                    </button>
                                }

                                <!-- Status Dropdown Menu -->
                                <div class="status-dropdown-menu" id="statusDropdown_@task.ProjectTaskId" style="display: none;">
                                    @{
                                        var availableStates = ViewData["AllStates"] as IEnumerable<SAAS_Projectplanningtool.Models.IndependentTables.State>;
                                        if (availableStates != null)
                                        {
                                            foreach (var state in availableStates)
                                            {
                                                <form method="post" asp-page-handler="UpdateTaskState" class="status-dropdown-item-form">
                                                    <input type="hidden" name="taskId" value="@task.ProjectTaskId" />
                                                    <input type="hidden" name="stateId" value="@state.StateId" />
                                                    <input type="hidden" name="projectId" value="@Model.Project.ProjectId" />
                                                    <button type="submit"
                                                            class="status-dropdown-item"
                                                            style="border-left: 4px solid @state.Color;">
                                                        <span class="status-color-indicator" style="background-color: @state.Color;"></span>
                                                        @state.StateName
                                                        @if (task.StateId == state.StateId)
                                                        {
                                                            <i class="fas fa-check ms-auto"></i>
                                                        }
                                                    </button>
                                                </form>
                                            }
                                        }
                                    }
                                </div>
                            </div>

                            <button type="button"
                                    class="btn btn-sm btn-icon"
                                    onclick="editTask('@task.ProjectTaskId', '@task.ProjectTaskName', '@(task.StartDate?.ToString("yyyy-MM-dd") ?? "")', '@(task.EndDate?.ToString("yyyy-MM-dd") ?? "")')"
                                    title="Bearbeiten">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

<div class="dropdown-backdrop"></div>

<link rel="stylesheet" href="~/css/ProjectStructureTreeItem.css" />

<script>
    function toggleSection(element) {
        const header = element;
        const item = header.closest('.structure-item');
        const children = item.querySelector('.structure-children');

        if (!children) return;

        const isExpanded = children.style.display !== 'none';

        if (isExpanded) {
            children.style.display = 'none';
            header.classList.remove('expanded');
        } else {
            children.style.display = 'block';
            header.classList.add('expanded');
        }
    }

    function toggleStatusDropdown(event, taskId) {
        event.stopPropagation();

        const button = event.currentTarget;
        const dropdown = document.getElementById(`statusDropdown_${taskId}`);

        // Schließe alle anderen Dropdowns
        document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
            if (menu.id !== `statusDropdown_${taskId}`) {
                menu.style.display = 'none';
            }
        });

        // Toggle aktuelles Dropdown
        const isCurrentlyOpen = dropdown.style.display === 'block';

        if (isCurrentlyOpen) {
            dropdown.style.display = 'none';


        } else {
            dropdown.style.display = 'block';

            // Position berechnen und setzen
            setTimeout(() => {
                positionDropdown(button, dropdown);
            }, 0);
        }
    }

    function positionDropdown(button, dropdown) {
        const buttonRect = button.getBoundingClientRect();
        const dropdownHeight = dropdown.offsetHeight;
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;

        // Horizontale Positionierung (rechts vom Button ausgerichtet)
        let left = buttonRect.right - dropdown.offsetWidth;

        // Falls zu weit links, dann am linken Rand des Buttons ausrichten
        if (left < 10) {
            left = buttonRect.left;
        }

        // Falls immer noch zu weit rechts
        if (left + dropdown.offsetWidth > viewportWidth - 10) {
            left = viewportWidth - dropdown.offsetWidth - 10;
        }

        // Vertikale Positionierung
        const spaceBelow = viewportHeight - buttonRect.bottom;
        const spaceAbove = buttonRect.top;

        let top;

        if (spaceBelow >= dropdownHeight || spaceBelow > spaceAbove) {
            // Platz unten oder mehr Platz unten als oben
            top = buttonRect.bottom + 5;
        } else {
            // Mehr Platz oben
            top = buttonRect.top - dropdownHeight - 5;
        }

        // Falls Dropdown über Viewport hinausgeht, anpassen
        if (top + dropdownHeight > viewportHeight - 10) {
            top = viewportHeight - dropdownHeight - 10;
        }

        if (top < 10) {
            top = 10;
        }

        dropdown.style.left = left + 'px';
        dropdown.style.top = top + 'px';
    }

    // Schließe Dropdowns beim Klicken außerhalb
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.status-dropdown-container')) {
            document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });

    // Verhindere Schließen beim Klicken innerhalb
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
            menu.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        });
    });

    // Repositioniere Dropdowns beim Scrollen oder Fenster-Resize
    let scrollTimeout;
    window.addEventListener('scroll', function() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(function() {
            document.querySelectorAll('.status-dropdown-menu').forEach(dropdown => {
                if (dropdown.style.display === 'block') {
                    const taskId = dropdown.id.replace('statusDropdown_', '');
                    const button = document.querySelector(`button[onclick*="'${taskId}'"]`);
                    if (button) {
                        positionDropdown(button, dropdown);
                    }
                }
            });
        }, 10);
    }, true);

    window.addEventListener('resize', function() {
        document.querySelectorAll('.status-dropdown-menu').forEach(dropdown => {
            if (dropdown.style.display === 'block') {
                const taskId = dropdown.id.replace('statusDropdown_', '');
                const button = document.querySelector(`button[onclick*="'${taskId}'"]`);
                if (button) {
                    positionDropdown(button, dropdown);
                }
            }
        });
    });
</script>