@page
@model SAAS_Projectplanningtool.Pages.Index1Model
@{
    ViewData["Title"] = "Dashboard";
}

<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1 class="welcome-title">Willkommen, @Model.CurrentEmployee?.EmployeeDisplayName</h1>
            <p class="company-name">@Model.CurrentCompany?.CompanyName</p>
            <span class="role-badge">@Model.CurrentEmployee?.IdentityRole?.Name Dashboard</span>
        </div>
        
        <!-- Global Search -->
        <div class="search-container">
            <form method="get" asp-page="/Search/GlobalSearch">
                <div class="search-box">
                    <input type="text" name="query" placeholder="Projekte, Aufgaben, Mitarbeiter, Kunden suchen..." class="search-input">
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid row">
        
        <!-- Project Overview Cards -->
        <div class="col-12">
            <section class="overview-cards">
                <div class="card-grid">
                    <div class="stat-card active-projects">
                        <div class="card-header">
                            <h3>Aktive Projekte</h3>
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="card-value">@Model.ActiveProjectsCount</div>
                        <a asp-page="/Projects/Index" class="card-link">Alle anzeigen</a>
                    </div>

                    <div class="stat-card archived-projects">
                        <div class="card-header">
                            <h3>Archivierte Projekte</h3>
                            <i class="fas fa-archive"></i>
                        </div>
                        <div class="card-value">@Model.ArchivedProjectsCount</div>
                        <a href="/Projects/Archive" class="card-link">Archiv öffnen</a>
                    </div>

                    <div class="stat-card upcoming-projects">
                        <div class="card-header">
                            <h3>Startend in 30 Tagen</h3>
                            <i class="fas fa-calendar-plus"></i>
                        </div>
                        <div class="card-value">@Model.UpcomingProjectsCount</div>
                        <a asp-page="/Projects/Upcoming" class="card-link">Details</a>
                    </div>

                    <div class="stat-card overdue-projects">
                        <div class="card-header">
                            <h3>Überfällige Projekte</h3>
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="card-value">@Model.OverdueProjectsCount</div>
                        <a asp-page="/Projects/Overdue" class="card-link">Sofort handeln</a>
                    </div>
                </div>
            </section>
        </div>

        <!-- Budget Status Section -->
        <div class="col-4">
            <section class="overview-card budget-section">
                <h2>Budget-Status</h2>
                <div class="budget-container">
                    @{
                        var visibleBudgetProjects = Model.ProjectsWithBudget.Take(5);
                        var hiddenBudgetProjects = Model.ProjectsWithBudget.Skip(5);
                    }

                    @foreach (var project in visibleBudgetProjects)
                    {
                        var budgetPercentage = project.Project.ProjectBudget != null && project.Project.ProjectBudget.InitialBudget > 0
                        ? (project.UsedBudget / project.Project.ProjectBudget.InitialBudget) * 100
                        : 0;
                        var warningClass = budgetPercentage > 90 ? "budget-warning" : budgetPercentage > 75 ? "budget-caution" : "budget-ok";

                        <a class="budget-item-link" href="Projects/BudgetPlanning?id=@project.Project.ProjectId">
                            <div class="budget-item @warningClass">
                                <div class="budget-header">
                                    <span class="project-name">@project.Project.ProjectName</span>
                                    <span class="budget-percentage">@budgetPercentage.ToString("F1")%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: @budgetPercentage%"></div>
                                </div>
                                <div class="budget-details">
                                    <span>@project.UsedBudget.ToString("C") von @project.Project.ProjectBudget?.InitialBudget.ToString("C")</span>
                                </div>
                            </div>
                        </a>
                    }

                    @if (hiddenBudgetProjects.Any())
                    {
                        <div class="hidden-budget-items" id="hiddenBudgetItems" style="display: none;">
                            @foreach (var project in hiddenBudgetProjects)
                            {
                                var budgetPercentage = project.Project.ProjectBudget != null && project.Project.ProjectBudget.InitialBudget > 0
                                ? (project.UsedBudget / project.Project.ProjectBudget.InitialBudget) * 100
                                : 0;
                                var warningClass = budgetPercentage > 90 ? "budget-warning" : budgetPercentage > 75 ? "budget-caution" : "budget-ok";

                                <a class="budget-item-link" href="Projects/BudgetPlanning?id=@project.Project.ProjectId">
                                    <div class="budget-item @warningClass">
                                        <div class="budget-header">
                                            <span class="project-name">@project.Project.ProjectName</span>
                                            <span class="budget-percentage">@budgetPercentage.ToString("F1")%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: @budgetPercentage%"></div>
                                        </div>
                                        <div class="budget-details">
                                            <span>@project.UsedBudget.ToString("C") von @project.Project.ProjectBudget?.InitialBudget.ToString("C")</span>
                                        </div>
                                    </div>
                                </a>
                            }
                        </div>

                        <button class="show-more-btn" id="showMoreBudget" onclick="toggleBudgetItems()">
                            <i class="fas fa-chevron-down"></i>
                            @hiddenBudgetProjects.Count() weitere anzeigen
                        </button>
                    }
                </div>

                @if (Model.HighBudgetProjects.Any())
                {
                    <div class="budget-warnings">
                        <h3><i class="fas fa-exclamation-circle"></i> Budget-Warnungen (>90%)</h3>
                        <ul class="warning-list">
                            @foreach (var project in Model.HighBudgetProjects)
                            {
                                <li>
                                    <a asp-page="/Projects/Details" asp-route-id="@project?.Project?.ProjectId">@project?.Project?.ProjectName</a>
                                    <span class="warning-percentage">@((project?.UsedBudget / project?.Project?.ProjectBudget?.InitialBudget * 100)?.ToString("F1"))%</span>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </section>
        </div>

        <!-- Resources & Workload -->
        <div class="col-4">
            <section class="overview-card resources-section">
                <h2>Ressourcen & Auslastung</h2>
            
                <div class="workload-grid">
                    @foreach (var employee in Model.EmployeeWorkload)
                    {
                        var workloadClass = employee.TaskCount > 10 ? "high-workload" : employee.TaskCount > 5 ? "medium-workload" : "low-workload";
                    
                        <div class="workload-item @workloadClass">
                            <div class="employee-info">
                                <h4>@employee.EmployeeDisplayName</h4>
                                <span class="hourly-rate">@employee.HourlyRateGroup?.HourlyRateGroupName (@employee.HourlyRateGroup?.HourlyRate.ToString("C")/h)</span>
                            </div>
                            <div class="workload-indicator">
                                <span class="task-count">@employee.TaskCount Aufgaben</span>
                                <div class="workload-bar">
                                    <div class="workload-fill" style="width: @Math.Min(employee.TaskCount * 10, 100)%"></div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="hourly-rate-stats">
                    <h3>Stundensatz-Statistik</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Durchschnittlicher Stundensatz:</span>
                            <span class="stat-value">@Model.AverageHourlyRate.ToString("C")</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Höchster Stundensatz:</span>
                            <span class="stat-value">@Model.HighestHourlyRate.ToString("C")</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Niedrigster Stundensatz:</span>
                            <span class="stat-value">@Model.LowestHourlyRate.ToString("C")</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div class="col-4">
        <!-- Quick Actions -->
            <div>
                <section class="overview-card quick-actions">
                    <h2>Schnelle Aktionen</h2>
                    <div class="action-buttons">
                        @if (Model.CanCreateProjects)
                        {
                            <a asp-page="/Projects/Create" class="action-btn primary">
                                <i class="fas fa-plus"></i>
                                Neues Projekt
                            </a>
                        }
                        @if (Model.CanCreateTasks)
                        {
                            <a asp-page="/Tasks/Create" class="action-btn secondary">
                                <i class="fas fa-tasks"></i>
                                Neue Aufgabe
                            </a>
                        }
                        @if (Model.CanCreateCustomers)
                        {
                            <a asp-page="/Customers/Create" class="action-btn secondary">
                                <i class="fas fa-user-plus"></i>
                                Neuer Kunde
                            </a>
                        }
                        @if (Model.CanCreateEmployees)
                        {
                            <a asp-page="/Employees/Create" class="action-btn secondary">
                                <i class="fas fa-user-tie"></i>
                                Neuer Mitarbeiter
                            </a>
                        }
                    </div>
                </section>
            </div>

            <div>
                <!-- Calendar Widget -->
                <section class="overview-card calendar-section">
                    <h2>Termine & Deadlines</h2>
                    <div class="calendar-widget">
                        <div class="calendar-header">
                            <button class="calendar-nav" id="prevMonth">&lt;</button>
                            <span class="calendar-range" id="currentMonth">@DateTime.Now.ToString("MMMM yyyy")</span>
                            <button class="calendar-nav" id="nextMonth">&gt;</button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be populated by JavaScript -->
                        </div>
                    </div>
            
                    <div class="overview-card upcoming-events">
                        <h3 class="calendar-range">Diese Woche</h3>
                        <div class="event-list">
                            @foreach (var eventItem in Model.ThisWeekEvents)
                            {
                                <div class="event-item">
                                    <div class="event-date">@eventItem.Date.ToString("dd.MM")</div>
                                    <div class="event-details">
                                        <span class="event-title">@eventItem.Title</span>
                                        <span class="event-type">@eventItem.Type</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </section>
            </div>
        </div>
        <!-- Budget Plan-Ist Vergleich -->
        <div class="col-12">
            <section class="overview-card budget-comparison-section">
                <div class="budget-comparison-header">
                    <h2><i class="fas fa-chart-bar me-2"></i>Budget Plan-Ist Vergleich</h2>

                    <!-- Multi-Select Projekt-Filter -->
                    <div class="budget-filter">
                        <div class="multi-select-wrapper" id="projectFilterWrapper">
                            <button type="button" class="multi-select-toggle" id="projectFilterToggle" onclick="toggleFilterDropdown()">
                                <i class="fas fa-filter me-2"></i>
                                <span id="filterLabel">Alle Projekte</span>
                                <i class="fas fa-chevron-down ms-2 toggle-arrow"></i>
                            </button>
                            <div class="multi-select-dropdown" id="projectFilterDropdown">
                                <div class="dropdown-actions">
                                    <button type="button" class="dropdown-action-btn" onclick="selectAllProjects()">
                                        <i class="fas fa-check-double me-1"></i>Alle
                                    </button>
                                    <button type="button" class="dropdown-action-btn" onclick="deselectAllProjects()">
                                        <i class="fas fa-times me-1"></i>Keine
                                    </button>
                                </div>
                                <div class="dropdown-options">
                                    @foreach (var project in Model.ProjectsWithBudget)
                                    {
                                        <label class="dropdown-option">
                                            <input type="checkbox"
                                                   value="@project.Project.ProjectId"
                                                   checked
                                                   onchange="updateBudgetCharts()" />
                                            <span class="option-checkmark"></span>
                                            <span class="option-label">@project.Project.ProjectName</span>
                                        </label>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="budget-chart-row">
                    <!-- 2/3 Säulendiagramm -->
                    <div class="budget-chart-bar">
                        <canvas id="budgetBarChart"></canvas>
                    </div>
                    <!-- 1/3 Tortendiagramm -->
                    <div class="budget-chart-pie">
                        <canvas id="budgetPieChart"></canvas>
                    </div>
                </div>
            </section>
        </div>

        <!-- Recent Activities -->
        <div class="col-4">
            <section class="overview-card activities-section">
                <h2>Letzte Änderungen</h2>
                <div class="activity-feed">
                    @foreach (var activity in Model.RecentActivities)
                    {
                        <div class="activity-item">
                            @* <div class="activity-icon">
                                <i class="fas @activity.Icon"></i>
                            </div> *@
                            <div class="activity-content">
                                <p class="activity-description">@activity.Description</p>
                                <div class="activity-meta">
                                    <span class="activity-user">@activity.ModifierName</span>
                                    <span class="activity-time">@activity.Timestamp.ToString("dd.MM.yyyy HH:mm")</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </section>
        </div>
        <!-- System Info -->
        <div class="col-4">
            <section class="overview-card system-info">
                <h2>System-Information</h2>
                <div class="info-cards">
                    <div class="info-card license-info">
                        <h3><i class="fas fa-certificate"></i> Lizenz-Status</h3>
                        <p><strong>@Model.CurrentCompany?.License?.LicenseName</strong></p>
                        <p class="license-details">Aktive Benutzer: @Model.ActiveUsersCount</p>
                    </div>
                
                    <div class="info-card system-stats">
                        <h3><i class="fas fa-chart-bar"></i> System-Statistiken</h3>
                        <ul>
                            <li>Gesamt Projekte: @Model.TotalProjectsCount</li>
                            <li>Gesamt Aufgaben: @Model.TotalTasksCount</li>
                            <li>Aktive Mitarbeiter: @Model.ActiveUsersCount</li>
                        </ul>
                    </div>
                </div>
            </section>
        </div>

    </div>
</div>

<!-- JavaScript for Interactive Elements -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab functionality
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked button and corresponding content
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });
    
    // Simple calendar functionality
    function updateCalendar() {
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        document.getElementById('currentMonth').textContent = 
            new Intl.DateTimeFormat('de-DE', { month: 'long', year: 'numeric' }).format(today);
    }
    
    // Initialize calendar
    updateCalendar();
    
    // Calendar navigation (basic implementation)
    document.getElementById('prevMonth')?.addEventListener('click', function() {
        // Implementation for previous month
        console.log('Previous month');
    });
    
    document.getElementById('nextMonth')?.addEventListener('click', function() {
        // Implementation for next month
        console.log('Next month');
    });
});
    function toggleBudgetItems() {
        const hiddenItems = document.getElementById('hiddenBudgetItems');
        const button = document.getElementById('showMoreBudget');
        const icon = button.querySelector('i');

        if (hiddenItems.style.display === 'none') {
            hiddenItems.style.display = 'block';
            button.innerHTML = '<i class="fas fa-chevron-up"></i> Weniger anzeigen';
            button.classList.add('expanded');
        } else {
            hiddenItems.style.display = 'none';
            const hiddenCount = hiddenItems.querySelectorAll('.budget-item').length;
            button.innerHTML = `<i class="fas fa-chevron-down"></i> ${hiddenCount} weitere anzeigen`;
            button.classList.remove('expanded');
        }
    }

    function toggleMyTasks() {
        const hiddenItems = document.getElementById('hiddenMyTasks');
        const button = document.getElementById('showMoreMyTasks');

        if (hiddenItems.style.display === 'none') {
            hiddenItems.style.display = 'block';
            button.innerHTML = '<i class="fas fa-chevron-up"></i> Weniger anzeigen';
            button.classList.add('expanded');
        } else {
            hiddenItems.style.display = 'none';
            const hiddenCount = hiddenItems.querySelectorAll('.task-item').length;
            button.innerHTML = `<i class="fas fa-chevron-down"></i> ${hiddenCount} weitere anzeigen`;
            button.classList.remove('expanded');
        }
    }

    function toggleTeamTasks() {
        const hiddenItems = document.getElementById('hiddenTeamTasks');
        const button = document.getElementById('showMoreTeamTasks');

        if (hiddenItems.style.display === 'none') {
            hiddenItems.style.display = 'block';
            button.innerHTML = '<i class="fas fa-chevron-up"></i> Weniger anzeigen';
            button.classList.add('expanded');
        } else {
            hiddenItems.style.display = 'none';
            const hiddenCount = hiddenItems.querySelectorAll('.task-item').length;
            button.innerHTML = `<i class="fas fa-chevron-down"></i> ${hiddenCount} weitere anzeigen`;
            button.classList.remove('expanded');
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        // Korrekte Pfade für JavaScript
        function loadCSS() {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = '/css/index.css'; // Absoluter Pfad ohne ~
            link.media = 'all';
            document.head.appendChild(link);
        }
        
        // CSS laden
        loadCSS();
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ===== Projektdaten global sammeln =====
    var allProjects = [];
    @foreach (var project in Model.ProjectsWithBudget)
    {
            @:allProjects.push({
            @:    id: '@project.Project.ProjectId',
            @:    name: '@Html.Raw(project.Project.ProjectName.Replace("'", "\\'"))',
            @:    planned: @(project.Project.ProjectBudget?.InitialBudget ?? 0),
            @:    used: @project.UsedBudget
            @:});
    }

    var barChart = null;
    var pieChart = null;

    // ===== Währungsformatierung =====
    function currencyFormat(value) {
        return new Intl.NumberFormat('de-DE', {
            style: 'currency', currency: 'EUR', maximumFractionDigits: 0
        }).format(value);
    }

    // ===== Filter-Dropdown Toggle =====
    function toggleFilterDropdown() {
        document.getElementById('projectFilterWrapper').classList.toggle('open');
    }

    // Dropdown schließen bei Klick außerhalb
    document.addEventListener('click', function(e) {
        var wrapper = document.getElementById('projectFilterWrapper');
        if (wrapper && !wrapper.contains(e.target)) {
            wrapper.classList.remove('open');
        }
    });

    // ===== Alle / Keine auswählen =====
    function selectAllProjects() {
        var checkboxes = document.querySelectorAll('#projectFilterDropdown input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = true);
        updateBudgetCharts();
    }

    function deselectAllProjects() {
        var checkboxes = document.querySelectorAll('#projectFilterDropdown input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        updateBudgetCharts();
    }

    // ===== Ausgewählte Projekt-IDs lesen =====
    function getSelectedProjectIds() {
        var checkboxes = document.querySelectorAll('#projectFilterDropdown input[type="checkbox"]:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    // ===== Filter-Label aktualisieren =====
    function updateFilterLabel(selectedCount, totalCount) {
        var label = document.getElementById('filterLabel');
        if (selectedCount === 0) {
            label.textContent = 'Keine Projekte';
        } else if (selectedCount === totalCount) {
            label.textContent = 'Alle Projekte';
        } else if (selectedCount === 1) {
            var selectedId = getSelectedProjectIds()[0];
            var proj = allProjects.find(p => p.id === selectedId);
            label.textContent = proj ? proj.name : '1 Projekt';
        } else {
            label.textContent = selectedCount + ' von ' + totalCount + ' Projekten';
        }
    }

    // ===== Charts aktualisieren =====
    function updateBudgetCharts() {
        var selectedIds = getSelectedProjectIds();
        var totalCount = allProjects.length;

        updateFilterLabel(selectedIds.length, totalCount);

        // Gefilterte Daten
        var filtered = selectedIds.length === 0
            ? []
            : allProjects.filter(p => selectedIds.includes(p.id));

        var projectNames = filtered.map(p => p.name);
        var plannedBudgets = filtered.map(p => p.planned);
        var usedBudgets = filtered.map(p => p.used);

        var totalPlanned = plannedBudgets.reduce((a, b) => a + b, 0);
        var totalUsed = usedBudgets.reduce((a, b) => a + b, 0);
        var totalRemaining = Math.max(totalPlanned - totalUsed, 0);

        // Bestehende Charts zerstören
        if (barChart) barChart.destroy();
        if (pieChart) pieChart.destroy();

        // Chart-Farben passend zum Dashboard
        var planColor = 'rgba(102, 126, 234, 0.75)';       // #667eea
        var planBorder = 'rgba(102, 126, 234, 1)';
        var istColor = 'rgba(118, 75, 162, 0.75)';          // #764ba2
        var istBorder = 'rgba(118, 75, 162, 1)';
        var verbrauchtColor = 'rgba(118, 75, 162, 0.85)';
        var verbrauchtBorder = 'rgba(118, 75, 162, 1)';
        var verbleibendColor = 'rgba(102, 126, 234, 0.85)';
        var verbleibendBorder = 'rgba(102, 126, 234, 1)';

        // ===== SÄULENDIAGRAMM (2/3) =====
        var barCtx = document.getElementById('budgetBarChart').getContext('2d');
        barChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: projectNames,
                datasets: [
                    {
                        label: 'Plan (€)',
                        data: plannedBudgets,
                        backgroundColor: planColor,
                        borderColor: planBorder,
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        label: 'Ist (€)',
                        data: usedBudgets,
                        backgroundColor: istColor,
                        borderColor: istBorder,
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'rectRounded',
                            padding: 16,
                            font: { size: 12, weight: '500' },
                            color: '#495057'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(44, 62, 80, 0.95)',
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + currencyFormat(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#6c757d', font: { size: 11 } }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.06)' },
                        ticks: {
                            color: '#6c757d',
                            font: { size: 11 },
                            callback: function(value) {
                                return currencyFormat(value);
                            }
                        }
                    }
                }
            }
        });

        // ===== DOUGHNUT (1/3) =====
        var pieCtx = document.getElementById('budgetPieChart').getContext('2d');
        pieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: ['Verbraucht (Ist)', 'Verbleibend'],
                datasets: [{
                    data: totalPlanned === 0 ? [0, 1] : [totalUsed, totalRemaining],
                    backgroundColor: [verbrauchtColor, verbleibendColor],
                    borderColor: [verbrauchtBorder, verbleibendBorder],
                    borderWidth: 2,
                    hoverOffset: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '62%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 16,
                            font: { size: 12, weight: '500' },
                            color: '#495057'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(44, 62, 80, 0.95)',
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                var pct = total > 0 ? ((context.raw / total) * 100).toFixed(1) : '0.0';
                                return context.label + ': ' + currencyFormat(context.raw) + ' (' + pct + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // ===== Initiale Anzeige =====
    document.addEventListener('DOMContentLoaded', function () {
        updateBudgetCharts();
    });
</script>