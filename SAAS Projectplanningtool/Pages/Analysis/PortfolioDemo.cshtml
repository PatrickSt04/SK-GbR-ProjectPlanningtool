@page
@model SAAS_Projectplanningtool.Pages.Analysis.PortfolioDemoModel
@using System.Globalization
@using System.Linq
@{
    ViewData["Title"] = "Portfolio Dashboard Demo";
    string Percent(double v) => v.ToString("0.0", CultureInfo.InvariantCulture) + "%";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
    .kpi-card {
        min-width: 160px;
    }

    .kpi-value {
        font-size: 1.4rem;
        font-weight: 600;
    }

    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }

    .status-Open {
        background: #0d6efd;
    }

    .status-InProgress {
        background: #ffc107;
    }

    .status-Done {
        background: #198754;
    }

    .table-fixed tbody {
        max-height: 260px;
        overflow-y: auto;
        display: block;
    }

        .table-fixed thead, .table-fixed tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
</style>

<div class="container-fluid py-3">
    <h2 class="mb-4">Portfolio Dashboard <small class="text-muted">(Demo)</small></h2>

    <!-- KPI STRIP -->
    <div class="row g-3 mb-3">
        <div class="col-auto" aria-label="Aktive Projekte">
            <div class="card kpi-card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted small">Aktive Projekte</div>
                    <div class="kpi-value">@Model.ActiveProjects</div>
                </div>
            </div>
        </div>
        <div class="col-auto" aria-label="Verzugsquote">
            <div class="card kpi-card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted small">Verzugsquote</div>
                    <div class="kpi-value @(Model.DelayRatePercent>20?"text-danger":(Model.DelayRatePercent>10?"text-warning":"text-success"))">@Percent(Model.DelayRatePercent)</div>
                </div>
            </div>
        </div>
        <div class="col-auto" aria-label="Fertigstellungsgrad">
            <div class="card kpi-card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted small">Fertigstellungsgrad</div>
                    <div class="kpi-value">@Percent(Model.PortfolioCompletionPercent)</div>
                </div>
            </div>
        </div>
        <div class="col-auto" aria-label="Median Restlaufzeit">
            <div class="card kpi-card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted small">Median Restlaufzeit</div>
                    <div class="kpi-value">@Model.MedianRemainingDays<span class="small"> Tage</span></div>
                </div>
            </div>
        </div>
        <div class="col-auto" aria-label="Change Intensity">
            <div class="card kpi-card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted small">Change Intensity (Proxy)</div>
                    <div class="kpi-value">@Model.ChangeIntensityProxy<span class="small"> /avg</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <!-- Status Distribution & Overdue Table Column -->
        <div class="col-xl-4 d-flex flex-column">
            <div class="card mb-3 flex-fill shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Statusverteilung</span>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" height="200" aria-label="Status Chart"></canvas>
                    <ul class="list-unstyled mb-0 mt-3 small">
                        @foreach (var s in Model.StatusDistribution)
                        {
                            <li><span class="status-dot status-@s.Status"></span>@s.Status: <strong>@s.Count</strong></li>
                        }
                    </ul>
                    @{
                        var totalActive = Model.StatusDistribution.Sum(s => s.Count);
                    }
                    <table class="table table-sm table-bordered mt-3 mb-0 align-middle">
                        <thead class="table-light"><tr><th>Status</th><th>Anzahl</th><th>% aktiv</th></tr></thead>
                        <tbody>
                            @foreach (var s in Model.StatusDistribution)
                            {
                                var perc = totalActive == 0 ? 0 : (double)s.Count * 100.0 / totalActive;
                                <tr>
                                    <td>@s.Status</td>
                                    <td>@s.Count</td>
                                    <td>@perc.ToString("0.0", CultureInfo.InvariantCulture)%</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card flex-fill shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Überfällige Projekte</span>
                    <span class="badge bg-danger">@Model.OverdueProjects.Count</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height:260px;">
                        <table class="table table-sm table-striped mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Projekt</th>
                                    <th class="text-end">Tage</th>
                                    <th class="text-end">Fertig%</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!Model.OverdueProjects.Any())
                                {
                                    <tr><td colspan="3" class="text-muted">Keine überfälligen Projekte 🎉</td></tr>
                                }
                                else
                                {
                                    foreach (var p in Model.OverdueProjects)
                                    {
                                        <tr>
                                            <td>@p.Project</td>
                                            <td class="text-end text-danger fw-semibold">@p.OverdueDays</td>
                                            <td class="text-end">@p.Completion.ToString("0.0", CultureInfo.InvariantCulture)%</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scatter Chart -->
        <div class="col-xl-8">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Fortschritt vs. Zeit (Projekte)</span>
                    <small class="text-muted">Grün = Fertigstellungsgrad ≥ Zeitfortschritt</small>
                </div>
                <div class="card-body d-flex flex-column">
                    <canvas id="scatterChart" height="320" aria-label="Progress Scatter"></canvas>
                    <div class="row mt-3 g-3 flex-grow-1">
                        <div class="col-md-4">
                            <div class="border rounded p-2 small h-100">
                                <div><span class="badge bg-success me-1">On/Ahead</span>@Model.ProjectsOnOrAhead</div>
                                <div><span class="badge bg-danger me-1">Behind</span>@Model.ProjectsBehindPlan</div>
                                <hr class="my-2" />
                                <div class="text-muted">Behind: Fertig% + 5 < Zeitfortschritt%</div>
                                <div class="mt-2 small">Gap = Fertig% - Zeit%</div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="table-responsive" style="max-height:180px;">
                                <table class="table table-sm table-hover mb-0 align-middle">
                                    <thead class="table-light">
                                        <tr><th>Projekt</th><th class="text-end">Zeit%</th><th class="text-end">Fertig%</th><th class="text-end">Gap</th></tr>
                                    </thead>
                                    <tbody>
                                        @if (!Model.BehindProjects.Any())
                                        {
                                            <tr><td colspan="4" class="text-muted">Keine Projekte hinter Plan 🎉</td></tr>
                                        }
                                        else
                                        {
                                            foreach (var b in Model.BehindProjects)
                                            {
                                                <tr class="@(b.Gap < -20 ? "table-danger" : b.Gap < -10 ? "table-warning" : "")">
                                                    <td>@b.Project</td>
                                                    <td class="text-end">@b.TimeProgress.ToString("0.0", CultureInfo.InvariantCulture)</td>
                                                    <td class="text-end">@b.Completion.ToString("0.0", CultureInfo.InvariantCulture)</td>
                                                    <td class="text-end">@b.Gap.ToString("0.0", CultureInfo.InvariantCulture)%</td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">Diagonal: idealer Verlauf (Fertigstellungsgrad ≈ Zeitfortschritt). Rechts unter Diagonale = hinter Plan, links über Diagonale = schnell.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Projects Table -->
    <div class="row g-3 mt-1">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">Projektübersicht</div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height:340px;">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Start</th>
                                    <th>Ende</th>
                                    <th>Status</th>
                                    <th class="text-end">Zeitfortschritt%</th>
                                    <th class="text-end">Fertig%</th>
                                    <th class="text-end">Tasks Done</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var p in Model.Projects)
                                {
                                    var totalDur = (p.EndDate - p.StartDate).TotalDays;
                                    var elapsed = (DateTime.Today - p.StartDate).TotalDays;
                                    var timeProg = totalDur <= 0 ? 0 : Math.Clamp(elapsed / totalDur * 100.0, 0, 200);
                                    var tasks = p.Tasks;
                                    var doneTasks = tasks.Count(t => t.Status == "Done");
                                    var completion = tasks.Count == 0 ? 0 : doneTasks * 100.0 / tasks.Count;
                                    <tr>
                                        <td>@p.Name</td>
                                        <td>@p.StartDate.ToString("dd.MM.yyyy")</td>
                                        <td>@p.EndDate.ToString("dd.MM.yyyy")</td>
                                        <td><span class="status-dot status-@p.Status"></span>@p.Status</td>
                                        <td class="text-end @(completion + 5 < timeProg ? "text-danger" : (completion >= timeProg ? "text-success" : ""))">@timeProg.ToString("0.0", CultureInfo.InvariantCulture)</td>
                                        <td class="text-end">@completion.ToString("0.0", CultureInfo.InvariantCulture)</td>
                                        <td class="text-end">@doneTasks / @tasks.Count</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ----- STATUS CHART (uses pre-serialized JSON) -----
    const statusLabels = @Html.Raw(Model.StatusLabelsJson);
    const statusCounts = @Html.Raw(Model.StatusCountsJson);
    const totalStatus = statusCounts.reduce((a,b)=>a+b,0);

    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'bar',
            data: {
                labels: statusLabels,
                datasets: [{
                    label: 'Projekte',
                    data: statusCounts,
                    backgroundColor: statusLabels.map(l => ({
                        'Open': 'rgba(13,110,253,0.55)',
                        'InProgress': 'rgba(255,193,7,0.55)',
                        'Done': 'rgba(25,135,84,0.55)'
                    }[l] || 'rgba(108,117,125,0.45)')),
                    borderColor: statusLabels.map(l => ({
                        'Open': 'rgba(13,110,253,1)',
                        'InProgress': 'rgba(255,193,7,1)',
                        'Done': 'rgba(25,135,84,1)'
                    }[l] || 'rgba(108,117,125,1)')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => `${ctx.parsed.y} Projekte (${(ctx.parsed.y/totalStatus*100).toFixed(1)}%)` } }
                },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            }
        });
    }

    // ----- SCATTER CHART -----
    const scatterPoints = @Html.Raw(Model.ScatterJson);
    const scatterColors = scatterPoints.map(p => {
        if (p.y + 5 < p.x) return '#dc3545';
        if (p.y >= p.x) return '#198754';
        return '#fd7e14';
    });

    const scatterCtx = document.getElementById('scatterChart');
    if (scatterCtx) {
        new Chart(scatterCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Projekte',
                    data: scatterPoints,
                    pointRadius: 6,
                    pointBackgroundColor: scatterColors,
                    pointBorderColor: '#333',
                    pointBorderWidth: 1
                }]
            },
            options: {
                parsing: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => { const r = ctx.raw; return `${r.label}: Zeit ${r.x.toFixed(1)}% / Fertig ${r.y.toFixed(1)}% (Δ ${(r.y - r.x).toFixed(1)}%)`; } } }
                },
                scales: {
                    x: { title: { display: true, text: 'Zeitfortschritt %' }, min: 0 },
                    y: { title: { display: true, text: 'Fertigstellungsgrad %' }, min: 0 }
                }
            }
        });
    }

    console.debug('StatusDistribution', statusLabels, statusCounts);
    console.debug('Scatter points', scatterPoints);
</script>